<!DOCTYPE html>
<html lang="de-CH">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vorlese-App ‚Äì Lesefluss (Frontend)</title>

  <style>
    /* =========================
       FONT: Deutschschweizer Basisschrift
       Lege die Dateien z.B. in ./fonts/ ab und passe die Pfade unten an:
       - fonts/DeutschschweizerBasisschrift.otf
       - fonts/DeutschschweizerBasisschrift.ttf
       ========================= */
    @font-face{
      font-family:"Deutschschweizer Basisschrift";
      src:
        url("./fonts/DeutschschweizerBasisschrift.ttf") format("truetype"),
        url("./fonts/DeutschschweizerBasisschrift.otf") format("opentype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    :root{
      --bg:#0b1220;
      --text:#e7eefc;
      --muted:#a9b7d6;
      --ok:#39d98a;
      --bad:#ff5c7a;
      --accent:#7aa2ff;
      --border:rgba(255,255,255,.12);
      --shadow:0 16px 40px rgba(0,0,0,.35);
      --radius:16px;

      font-family:
        "Deutschschweizer Basisschrift",
        system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(122,162,255,.18), transparent 55%),
                  radial-gradient(900px 700px at 90% 30%, rgba(57,217,138,.12), transparent 55%),
                  radial-gradient(900px 700px at 30% 95%, rgba(255,92,122,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      box-sizing:border-box;
    }
    .app{
      width:min(1100px, 100%);
      display:grid;
      gap:14px;
      position:relative;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .badge{
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(0,0,0,.18);
    }
    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .section{
      padding:16px;
      display:grid;
      gap:14px;
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .grid{
      display:grid;
      gap:12px;
      grid-template-columns: repeat(12, 1fr);
    }
    .col-6{grid-column: span 6;}
    .col-4{grid-column: span 4;}
    .col-8{grid-column: span 8;}
    .col-12{grid-column: span 12;}
    @media (max-width: 860px){
      .col-6,.col-4,.col-8{grid-column: span 12;}
    }
    label{
      font-size:13px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }
    select,input[type="text"],textarea{
      width:100%;
      box-sizing:border-box;
      background:rgba(0,0,0,.22);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-size:16px; /* etwas gr√∂sser f√ºr Kinder */
      font-family: inherit;
    }
    textarea{min-height:92px; resize:vertical;}

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      user-select:none;
      transition:transform .04s ease, background .12s ease, border-color .12s ease;
      font-family: inherit;
      font-size:16px;
    }
    .btn:active{transform:translateY(1px);}
    .btn.primary{
      background:linear-gradient(180deg, rgba(122,162,255,.30), rgba(122,162,255,.14));
      border-color:rgba(122,162,255,.45);
    }
    .btn.ok{
      background:linear-gradient(180deg, rgba(57,217,138,.26), rgba(57,217,138,.12));
      border-color:rgba(57,217,138,.42);
    }
    .btn.bad{
      background:linear-gradient(180deg, rgba(255,92,122,.22), rgba(255,92,122,.10));
      border-color:rgba(255,92,122,.40);
    }
    .btn.ghost{
      background:transparent;
    }
    .btn[disabled]{
      opacity:.55;
      cursor:not-allowed;
    }
    .btn.big{
      padding:14px 16px;
      font-size:18px;
      border-radius:16px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.16);
      color:var(--muted);
      font-size:13px;
    }
    .bigTarget{
      font-size: clamp(30px, 4.6vw, 58px);
      font-weight:900;
      line-height:1.15;
      letter-spacing:.2px;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
      font-family: inherit;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
      white-space:pre-wrap;
      word-break:break-word;
      background:rgba(0,0,0,.20);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      color:#dbe6ff;
    }
    .muted{color:var(--muted);}
    .feedback{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.16);
      font-weight:900;
      letter-spacing:.2px;
      font-size:16px;
    }
    .feedback.ok{border-color:rgba(57,217,138,.45); background:rgba(57,217,138,.12); color:#dfffea;}
    .feedback.bad{border-color:rgba(255,92,122,.45); background:rgba(255,92,122,.10); color:#ffe2e8;}
    .hidden{display:none !important;}
    .divider{
      height:1px;
      background:var(--border);
      margin:6px 0;
    }
    .footerNote{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    /* Info button (blue round with white I) */
    .infoBtn{
      width:44px;
      height:44px;
      border-radius:999px;
      border:1px solid rgba(122,162,255,.55);
      background:linear-gradient(180deg, rgba(122,162,255,.38), rgba(122,162,255,.18));
      color:#ffffff;
      font-weight:1000;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      box-shadow:0 10px 26px rgba(0,0,0,.30);
    }
    .infoBtn:active{transform:translateY(1px);}
    .infoBtn span{font-size:18px; line-height:1; transform:translateY(-1px);}

    /* Drawer / modal for teacher options */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:50;
    }
    .overlay.open{display:flex;}
    .drawer{
      width:min(980px, 100%);
      border:1px solid var(--border);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(16,26,46,.98), rgba(7,12,22,.96));
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      padding:14px;
      display:grid;
      gap:12px;
    }
    .drawerHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .drawerTitle{
      font-weight:1000;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .drawerTitle .mini{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    .closeBtn{
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
    }

    /* Start screen layout tweaks */
    .modeRow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .modeRow .btn{
      flex:1 1 220px;
    }
    .levelRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    @media (max-width: 720px){
      .levelRow{grid-template-columns: 1fr;}
    }
    .levelRow .btn{
      width:100%;
      justify-content:center;
      text-align:center;
    }
    .selected{
      outline:2px solid rgba(122,162,255,.55);
      border-color:rgba(122,162,255,.65) !important;
      background:linear-gradient(180deg, rgba(122,162,255,.32), rgba(122,162,255,.16)) !important;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <span>üìñ Vorlese-App</span>
        <span class="badge">20 Aufgaben</span>
      </div>
      <div class="row" style="gap:12px;">
        <span class="badge" id="srBadge">üéôÔ∏è ‚Ä¶</span>
        <button id="btnInfo" class="infoBtn" aria-label="Info"><span>I</span></button>
      </div>
    </div>

    <!-- START SCREEN (simplified for students) -->
    <div id="screenStart" class="card">
      <div class="section">
        <div class="row" style="justify-content:space-between;">
          <div class="muted" style="font-size:14px;font-weight:800;">W√§hle aus:</div>
        </div>

        <div>
          <div class="muted" style="margin-bottom:8px;font-weight:800;">Modus</div>
          <div class="modeRow">
            <button id="btnModeWords" class="btn big selected" type="button">W√∂rter</button>
            <button id="btnModeSent" class="btn big" type="button">S√§tze</button>
          </div>
        </div>

        <div>
          <div class="muted" style="margin-bottom:8px;font-weight:800;">Schwierigkeit</div>
          <div class="levelRow">
            <button id="btnLvlEasy" class="btn big selected" type="button">einfach<br><span class="muted" style="font-weight:800;">1. Klasse</span></button>
            <button id="btnLvlMed" class="btn big" type="button">mittel<br><span class="muted" style="font-weight:800;">2. Klasse</span></button>
            <button id="btnLvlHard" class="btn big" type="button">schwierig<br><span class="muted" style="font-weight:800;">3. Klasse</span></button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button id="btnStart" class="btn primary big">Start</button>
        </div>

        <div class="footerNote">
          Tipp: Dr√ºcke üé§ Sprechen, lies laut vor, dann ‚Äû√úberpr√ºfen‚Äú.
        </div>
      </div>
    </div>

    <!-- QUIZ SCREEN -->
    <div id="screenQuiz" class="card hidden">
      <div class="section">
        <div class="row" style="justify-content:space-between;">
          <span class="pill">üìå <b id="progressText">Aufgabe 1 von 20</b></span>
          <span class="pill">‚úÖ richtig: <b id="rightCount">0</b> ‚Ä¢ ‚ùå falsch: <b id="wrongCount">0</b></span>
        </div>

        <div id="targetBox" class="bigTarget">‚Ä¶</div>

        <div class="row">
          <button id="btnMic" class="btn ok big">üé§ Sprechen</button>
          <button id="btnCheck" class="btn primary big">√úberpr√ºfen</button>
          <button id="btnNext" class="btn ghost big" disabled>N√§chste</button>
        </div>

        <div id="fallbackWrap" class="grid hidden">
          <div class="col-12">
            <div class="feedback bad">Spracherkennung ist nicht verf√ºgbar. Bitte Text eingeben.</div>
          </div>
          <div class="col-12">
            <label for="fallbackInput">Eingabe</label>
            <input id="fallbackInput" type="text" placeholder="Gelesenen Text eingeben‚Ä¶" />
          </div>
        </div>

        <div class="grid">
          <div class="col-6">
            <label>Rohtext (1:1)</label>
            <div id="rawText" class="mono"></div>
          </div>
          <div class="col-6">
            <label>Normalisiert</label>
            <div id="normText" class="mono"></div>
          </div>
          <div class="col-12">
            <div id="feedback" class="feedback">Bereit.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RESULT SCREEN -->
    <div id="screenResult" class="card hidden">
      <div class="section">
        <div class="row" style="justify-content:space-between;">
          <span class="pill">üèÅ <b>Ergebnis</b></span>
          <span class="pill">20 Aufgaben</span>
        </div>

        <div class="row" style="gap:12px; flex-wrap:wrap;">
          <div class="pill" style="font-size:15px;">‚úÖ Richtig: <b id="resRight">0</b></div>
          <div class="pill" style="font-size:15px;">‚ùå Falsch: <b id="resWrong">0</b></div>
        </div>

        <div class="row">
          <button id="btnDone" class="btn primary big">Fertig</button>
          <button id="btnPractice" class="btn ghost big">Weiter √ºben</button>
        </div>
      </div>
    </div>

    <!-- TEACHER INFO / SETTINGS (hidden behind info button) -->
    <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-label="Info">
      <div class="drawer">
        <div class="drawerHeader">
          <div class="drawerTitle">
            <span>‚ÑπÔ∏è Info & Einstellungen</span>
            <span class="mini">(f√ºr Lehrpersonen)</span>
          </div>
          <button id="btnCloseInfo" class="closeBtn" type="button">Schliessen</button>
        </div>

        <div class="grid">
          <div class="col-6">
            <label for="orderSel">Reihenfolge</label>
            <select id="orderSel">
              <option value="random">Zuf√§llig</option>
              <option value="inorder">In Reihenfolge</option>
            </select>
          </div>

          <div class="col-6">
            <label for="audioBase">Audio-Pfad (optional)</label>
            <input id="audioBase" type="text" placeholder="z.B. ./audio/  (Default: Root)" />
            <div class="footerNote">Audiofiles: correct.wav, error.wav</div>
          </div>

          <div class="col-6">
            <label for="removeFillers">Vergleich</label>
            <label class="pill" style="cursor:pointer; width:fit-content;">
              <input id="removeFillers" type="checkbox" checked style="transform:translateY(1px);" />
              F√ºllw√∂rter entfernen (√§h/√§hm/also/und/bitte/ja/genau)
            </label>
          </div>

          <div class="col-6">
            <label for="showExpectedOnFail">Feedback</label>
            <label class="pill" style="cursor:pointer; width:fit-content;">
              <input id="showExpectedOnFail" type="checkbox" />
              Bei Fehler ‚ÄûRichtig w√§re ‚Ä¶‚Äú anzeigen
            </label>
          </div>

          <div class="col-12">
            <div class="divider"></div>
            <div class="row" style="justify-content:space-between; gap:12px;">
              <div class="footerNote">
                Spracherkennung ist fix auf <b>de-CH</b> gesetzt (Schweiz), damit keine ‚Äû√ü‚Äú-Schreibung erzwungen wird.
              </div>
              <div class="pill">üéôÔ∏è Status: <b id="srAvail">‚Äî</b></div>
            </div>
            <div class="footerNote">
              LearningView Abschluss: <span class="mono" style="display:inline-block; padding:3px 8px;">window.parent.postMessage("AppSolved","*")</span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
  (function(){
    "use strict";

    // =========================
    // Fixed SpeechRecognition language
    // =========================
    const SR_LANG = "de-CH"; // Swiss German locale => tends to avoid "√ü" spelling

    // =========================
    // Config
    // =========================
    const TASKS_TOTAL = 20;
    const FILLERS = new Set(["√§h","√§hm","also","und","bitte","ja","genau"]);
    const AUDIO_OK_FILE = "correct.wav";
    const AUDIO_BAD_FILE = "error.wav";
    const SILENCE_MS = 900;

    // =========================
    // Lists: Words (graded)
    // =========================
    const WORDS_LVL1 = [
      "mama","papa","oma","opa","haus","hund","katze","ball","brot","wasser",
      "buch","schule","kind","hand","nase","mund","baum","sonne","mond","see",
      "stuhl","tisch","apfel","saft","weg","tor","boot","maus","hase","eule"
    ];
    const WORDS_LVL2 = [
      "fenster","garten","drachen","blume","fisch","wolke","regen","kuchen","tasche","jacke",
      "wiese","vogel","kinder","pause","kiste","biber","igel","kiesel","schiff","lampe",
      "zaun","klingel","brille","spiegel","schnee","winter","sommer","herbst","fr√ºhling","morgen"
    ];
    const WORDS_LVL3 = [
      "eichh√∂rnchen","schmetterling","regenbogen","abenteuer","schneeflocke","zahnb√ºrste","feuerwehr","gummistiefel","taschenlampe","spaziergang",
      "bilderrahmen","schn√ºrsenkel","kastanienbaum","sternenschnuppe","sommerferien","lieblingsbuch","turnhalle","schulzimmer","trommelwirbel","drachenflieger",
      "wasserflasche","blumenwiese","klingelton","bauernhof","himmelblau","pausenplatz","wintermantel","zirkusclown","schneemann","schokokuchen"
    ];

    // =========================
    // Lists: 50 short first-reader sentences
    //  - LVL1: very short
    //  - LVL2: short
    //  - LVL3: a bit longer
    // =========================
    const SENT_LVL1 = [
      "Ich sehe einen Hund.",
      "Du bist da.",
      "Mama hat Zeit.",
      "Papa ist nett.",
      "Die Sonne ist warm.",
      "Der Ball ist rot.",
      "Das Kind lacht.",
      "Ich esse Brot.",
      "Wir trinken Wasser.",
      "Oma liest ein Buch.",
      "Opa kommt jetzt.",
      "Die Katze schl√§ft.",
      "Der Vogel singt.",
      "Ich gehe zur Schule.",
      "Du rennst schnell.",
      "Wir spielen draussen."
    ];

    const SENT_LVL2 = [
      "Ich male ein Haus.",
      "Der Baum ist gross.",
      "Das Baby weint.",
      "Ich h√∂re Musik.",
      "Wir sind froh.",
      "Der Zug f√§hrt weg.",
      "Die T√ºr ist zu.",
      "Das Fenster ist offen.",
      "Ich habe Hunger.",
      "Der Hund l√§uft √ºber den Weg.",
      "Die Katze sitzt auf dem Stuhl.",
      "Im See schwimmt ein Fisch.",
      "Der Regen f√§llt ganz fein.",
      "Papa f√§hrt mit dem Auto los.",
      "Wir spielen im Hof mit dem Ball.",
      "Ich sehe den Mond am Himmel.",
      "Das Kind springt √ºber einen Stein."
    ];

    const SENT_LVL3 = [
      "Wir gehen zusammen nach Hause.",
      "Heute backt Mama einen Kuchen.",
      "Ich packe mein Buch in die Tasche.",
      "Der Wind pfeift um das Haus.",
      "Oma kocht Suppe f√ºr uns alle.",
      "Opa erz√§hlt eine gute Geschichte.",
      "Der Vogel fliegt hoch hinauf.",
      "Ich finde einen kleinen Schatz im Sand.",
      "Wir bauen eine Burg aus Holz.",
      "Die Sonne scheint durch das Fenster.",
      "Ich h√∂re ein leises Klopfen an der T√ºr.",
      "Der Zug f√§hrt schnell durch den Tunnel.",
      "Wir r√§umen das Zimmer ganz auf.",
      "Ich trage den Mantel im Winter gern.",
      "Im Wald h√∂re ich viele Tiere.",
      "Am Abend putze ich meine Z√§hne.",
      "Ich laufe leise zum Tor."
    ];

    // =========================
    // DOM
    // =========================
    const el = (id)=>document.getElementById(id);

    const screenStart = el("screenStart");
    const screenQuiz = el("screenQuiz");
    const screenResult = el("screenResult");

    const btnModeWords = el("btnModeWords");
    const btnModeSent = el("btnModeSent");

    const btnLvlEasy = el("btnLvlEasy");
    const btnLvlMed  = el("btnLvlMed");
    const btnLvlHard = el("btnLvlHard");

    const btnStart = el("btnStart");

    const progressText = el("progressText");
    const targetBox = el("targetBox");
    const btnMic = el("btnMic");
    const btnCheck = el("btnCheck");
    const btnNext = el("btnNext");
    const rawText = el("rawText");
    const normText = el("normText");
    const feedback = el("feedback");
    const rightCount = el("rightCount");
    const wrongCount = el("wrongCount");

    const fallbackWrap = el("fallbackWrap");
    const fallbackInput = el("fallbackInput");

    const resRight = el("resRight");
    const resWrong = el("resWrong");
    const btnDone = el("btnDone");
    const btnPractice = el("btnPractice");

    const srBadge = el("srBadge");
    const srAvail = el("srAvail");

    // teacher overlay
    const overlay = el("overlay");
    const btnInfo = el("btnInfo");
    const btnCloseInfo = el("btnCloseInfo");

    // teacher options
    const orderSel = el("orderSel");
    const audioBase = el("audioBase");
    const removeFillers = el("removeFillers");
    const showExpectedOnFail = el("showExpectedOnFail");

    // =========================
    // Student choices (simplified UI)
    // =========================
    let uiMode = "words";  // words | sentences
    let uiLevel = "easy";  // easy | med | hard

    function setMode(mode){
      uiMode = mode;
      btnModeWords.classList.toggle("selected", mode === "words");
      btnModeSent.classList.toggle("selected", mode === "sentences");
    }
    function setLevel(level){
      uiLevel = level;
      btnLvlEasy.classList.toggle("selected", level === "easy");
      btnLvlMed.classList.toggle("selected", level === "med");
      btnLvlHard.classList.toggle("selected", level === "hard");
    }

    // defaults
    setMode("words");
    setLevel("easy");

    btnModeWords.addEventListener("click", ()=>setMode("words"));
    btnModeSent.addEventListener("click", ()=>setMode("sentences"));
    btnLvlEasy.addEventListener("click", ()=>setLevel("easy"));
    btnLvlMed.addEventListener("click", ()=>setLevel("med"));
    btnLvlHard.addEventListener("click", ()=>setLevel("hard"));

    // =========================
    // SpeechRecognition
    // =========================
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const hasSR = !!SR;

    srBadge.textContent = hasSR ? "üéôÔ∏è bereit" : "üéôÔ∏è nicht verf√ºgbar";
    srAvail.textContent = hasSR ? "verf√ºgbar" : "nicht verf√ºgbar";

    let recognition = null;
    let isListening = false;

    // Buffer strategy
    let speechBuffer = "";
    let finalChunks = [];
    let silenceTimer = null;
    let hadFinalChunk = false;

    function setupRecognition(){
      if(!hasSR) return;
      recognition = new SR();

      // FIXED LANGUAGE
      recognition.lang = SR_LANG;

      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.maxAlternatives = 8;

      recognition.onresult = (event)=>{
        for(let i = event.resultIndex; i < event.results.length; i++){
          const res = event.results[i];
          const alt0 = res && res[0] ? (res[0].transcript || "") : "";
          const transcript = alt0.trim();

          if(res.isFinal){
            if(transcript){
              const last = finalChunks.length ? finalChunks[finalChunks.length-1] : "";
              if(transcript !== last){
                finalChunks.push(transcript);
                if(finalChunks.length > 40) finalChunks = finalChunks.slice(-40);
                if(speechBuffer) speechBuffer += " ";
                speechBuffer += transcript;
                hadFinalChunk = true;
              }
            }
          }

          // UI shows final buffer + interim (without storing interim)
          let interim = "";
          if(!res.isFinal && transcript) interim = transcript;

          const combined = (speechBuffer + (interim ? (" " + interim) : "")).trim();
          rawText.textContent = combined || "‚Äî";
          normText.textContent = normalizeText(combined, {removeFillers: removeFillers.checked}) || "‚Äî";
        }
        restartSilenceTimer();
      };

      recognition.onerror = ()=>{
        setFeedback("Fehler bei der Spracherkennung.", "bad");
        stopListening(true);
      };

      recognition.onend = ()=>{
        isListening = false;
        updateMicButton();
        clearSilenceTimer();
      };
    }

    function restartSilenceTimer(){
      if(!hasSR) return;
      clearSilenceTimer();
      silenceTimer = setTimeout(()=>{
        if(isListening && hadFinalChunk){
          stopListening(false);
        }
      }, SILENCE_MS);
    }
    function clearSilenceTimer(){
      if(silenceTimer){
        clearTimeout(silenceTimer);
        silenceTimer = null;
      }
    }

    function startListening(){
      if(!hasSR || !recognition) return;

      speechBuffer = "";
      finalChunks = [];
      hadFinalChunk = false;
      rawText.textContent = "‚Äî";
      normText.textContent = "‚Äî";

      // ensure fixed language every time
      recognition.lang = SR_LANG;

      try{
        recognition.start();
        isListening = true;
        updateMicButton();
        setFeedback("Sprich jetzt.", "");
        restartSilenceTimer();
      }catch(_){
        setFeedback("Spracherkennung konnte nicht gestartet werden.", "bad");
        isListening = false;
        updateMicButton();
      }
    }

    function stopListening(){
      if(!hasSR || !recognition) return;
      try{ recognition.stop(); }catch(_){}
      isListening = false;
      updateMicButton();
      clearSilenceTimer();
    }

    function toggleListening(){
      if(!hasSR) return;
      if(!recognition) setupRecognition();
      if(!audioOk || !audioBad) initAudio();
      if(isListening) stopListening();
      else startListening();
    }

    function updateMicButton(){
      btnMic.textContent = isListening ? "‚èπÔ∏è Stop" : "üé§ Sprechen";
      btnMic.classList.toggle("bad", isListening);
      btnMic.classList.toggle("ok", !isListening);
      srBadge.textContent = hasSR ? (isListening ? "üéôÔ∏è h√∂rt zu‚Ä¶" : "üéôÔ∏è bereit") : "üéôÔ∏è nicht verf√ºgbar";
    }

    // =========================
    // Audio
    // =========================
    let audioOk = null;
    let audioBad = null;

    function getAudioBase(){
      const base = (audioBase.value || "").trim();
      if(!base) return "";
      return base.endsWith("/") ? base : (base + "/");
    }

    function initAudio(){
      const base = getAudioBase();
      audioOk = new Audio(base + AUDIO_OK_FILE);
      audioBad = new Audio(base + AUDIO_BAD_FILE);
    }
    function playOk(){
      if(!audioOk) initAudio();
      try{ audioOk.currentTime = 0; audioOk.play(); }catch(_){}
    }
    function playBad(){
      if(!audioBad) initAudio();
      try{ audioBad.currentTime = 0; audioBad.play(); }catch(_){}
    }

    // =========================
    // Normalization & Matching
    // =========================
    function normalizeText(s, opts){
      const remove = !!(opts && opts.removeFillers);
      let t = (s || "").toLowerCase();

      // remove punctuation -> spaces
      try{
        t = t.replace(/[^\p{L}\p{N}\s]/gu, " ");
      }catch(_){
        t = t.replace(/[^a-z0-9√§√∂√º√ü\s]/gi, " ");
      }

      t = t.replace(/\s+/g, " ").trim();

      // Swiss German: optionally map √ü -> ss (defensive, in case API returns √ü anyway)
      // (Does not invent; it's a deterministic normalization rule.)
      t = t.replace(/√ü/g, "ss");

      if(remove){
        const parts = t.split(" ").filter(Boolean).filter(w => !FILLERS.has(w));
        t = parts.join(" ");
      }
      return t;
    }

    function tokenize(norm){
      if(!norm) return [];
      return norm.split(" ").filter(Boolean);
    }
    function escapeRegex(s){
      return (s || "").replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }
    function containsWholeWordToken(spokenNorm, targetNorm){
      const w = targetNorm.trim();
      if(!w) return false;
      const re = new RegExp("(^|\\s)" + escapeRegex(w) + "($|\\s)");
      return re.test(spokenNorm);
    }
    function isSubsequenceMatch(targetTokens, spokenTokens, threshold){
      if(targetTokens.length === 0) return false;
      let i = 0;
      for(let j = 0; j < spokenTokens.length && i < targetTokens.length; j++){
        if(spokenTokens[j] === targetTokens[i]) i++;
      }
      return (i / targetTokens.length) >= threshold;
    }

    function compareDeterministic(targetText, spokenText, mode){
      const tNorm = normalizeText(targetText, {removeFillers: removeFillers.checked});
      const sNorm = normalizeText(spokenText, {removeFillers: removeFillers.checked});

      if(!tNorm) return {ok:false, spokenNorm:sNorm, targetNorm:tNorm};
      if(!sNorm) return {ok:false, spokenNorm:sNorm, targetNorm:tNorm};

      if(mode === "words"){
        const tTokens = tokenize(tNorm);
        if(tTokens.length === 1){
          return {ok: containsWholeWordToken(sNorm, tNorm), spokenNorm:sNorm, targetNorm:tNorm};
        }
        return {ok: isSubsequenceMatch(tTokens, tokenize(sNorm), 1.0), spokenNorm:sNorm, targetNorm:tNorm};
      }

      // sentences:
      const longerIsSpoken = sNorm.length >= tNorm.length;
      if(longerIsSpoken && sNorm.includes(tNorm)) return {ok:true, spokenNorm:sNorm, targetNorm:tNorm};
      if(!longerIsSpoken && tNorm.includes(sNorm)) return {ok:true, spokenNorm:sNorm, targetNorm:tNorm};

      return {ok: isSubsequenceMatch(tokenize(tNorm), tokenize(sNorm), 0.90), spokenNorm:sNorm, targetNorm:tNorm};
    }

    // =========================
    // Run state
    // =========================
    let run = null;

    function buildPool(){
      if(uiMode === "words"){
        if(uiLevel === "easy") return WORDS_LVL1.slice();
        if(uiLevel === "med")  return WORDS_LVL2.slice();
        return WORDS_LVL3.slice();
      }else{
        if(uiLevel === "easy") return SENT_LVL1.slice();
        if(uiLevel === "med")  return SENT_LVL2.slice();
        return SENT_LVL3.slice();
      }
    }

    function shuffleInPlace(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function startRun(){
      const pool = buildPool();
      const items = pool.slice();

      if(orderSel.value === "random") shuffleInPlace(items);

      run = {
        mode: uiMode,
        items,
        index: 0,
        right: 0,
        wrong: 0,
        checked: false,
        lastTarget: ""
      };

      if(hasSR && !recognition) setupRecognition();
      initAudio();

      goQuiz();
      loadTask();
    }

    function goStart(){
      screenStart.classList.remove("hidden");
      screenQuiz.classList.add("hidden");
      screenResult.classList.add("hidden");
      if(isListening) stopListening();
    }
    function goQuiz(){
      screenStart.classList.add("hidden");
      screenQuiz.classList.remove("hidden");
      screenResult.classList.add("hidden");
    }
    function goResult(){
      screenStart.classList.add("hidden");
      screenQuiz.classList.add("hidden");
      screenResult.classList.remove("hidden");
      if(isListening) stopListening();

      resRight.textContent = String(run ? run.right : 0);
      resWrong.textContent = String(run ? run.wrong : 0);
    }

    function setFeedback(text, kind){
      feedback.textContent = text;
      feedback.classList.remove("ok","bad");
      if(kind === "ok") feedback.classList.add("ok");
      if(kind === "bad") feedback.classList.add("bad");
    }

    function updateCounts(){
      rightCount.textContent = String(run ? run.right : 0);
      wrongCount.textContent = String(run ? run.wrong : 0);
    }

    function loadTask(){
      if(!run) return;
      if(run.index >= TASKS_TOTAL){
        goResult();
        return;
      }

      const target = run.items[run.index];
      run.lastTarget = target;

      progressText.textContent = `Aufgabe ${run.index + 1} von ${TASKS_TOTAL}`;
      targetBox.textContent = target;

      rawText.textContent = "‚Äî";
      normText.textContent = "‚Äî";
      setFeedback("Bereit.", "");
      run.checked = false;

      speechBuffer = "";
      finalChunks = [];
      hadFinalChunk = false;

      btnNext.disabled = true;

      if(!hasSR){
        fallbackWrap.classList.remove("hidden");
        fallbackInput.value = "";
      }else{
        fallbackWrap.classList.add("hidden");
      }

      updateCounts();
    }

    function getCurrentSpokenRaw(){
      if(!hasSR) return (fallbackInput.value || "").trim();
      return (speechBuffer || "").trim();
    }

    function doCheck(){
      if(!run) return;
      if(isListening) stopListening();

      const spokenRaw = getCurrentSpokenRaw();
      const cmp = compareDeterministic(run.lastTarget, spokenRaw, run.mode);

      rawText.textContent = spokenRaw || "‚Äî";
      normText.textContent = cmp.spokenNorm || "‚Äî";

      if(cmp.ok){
        run.right++;
        setFeedback("Richtig ‚úÖ", "ok");
        playOk();
      }else{
        run.wrong++;
        const showExpected = !!showExpectedOnFail.checked;
        const extra = showExpected ? `  Richtig w√§re: ${run.lastTarget}` : "";
        setFeedback("Falsch ‚ùå" + extra, "bad");
        playBad();
      }

      run.checked = true;
      btnNext.disabled = false;
      updateCounts();
    }

    function doNext(){
      if(!run || !run.checked) return;
      run.index++;
      loadTask();
    }

    function doDone(){
      try{ window.parent.postMessage("AppSolved","*"); }catch(_){}
    }

    // =========================
    // Teacher info drawer
    // =========================
    function openInfo(){ overlay.classList.add("open"); }
    function closeInfo(){ overlay.classList.remove("open"); }

    btnInfo.addEventListener("click", openInfo);
    btnCloseInfo.addEventListener("click", closeInfo);
    overlay.addEventListener("click", (e)=>{
      if(e.target === overlay) closeInfo();
    });
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && overlay.classList.contains("open")) closeInfo();
    });

    // =========================
    // Buttons
    // =========================
    btnStart.addEventListener("click", startRun);

    btnMic.addEventListener("click", ()=>{
      if(!hasSR){
        setFeedback("Spracherkennung ist nicht verf√ºgbar. Nutze das Eingabefeld.", "bad");
        return;
      }
      toggleListening();
    });

    btnCheck.addEventListener("click", doCheck);
    btnNext.addEventListener("click", doNext);

    btnDone.addEventListener("click", doDone);
    btnPractice.addEventListener("click", ()=>{
      run = null;
      goStart();
    });

    audioBase.addEventListener("change", ()=>{
      audioOk = null;
      audioBad = null;
    });

    // Init
    if(!hasSR) fallbackWrap.classList.remove("hidden");
    goStart();
    updateMicButton();
    rawText.textContent = "‚Äî";
    normText.textContent = "‚Äî";
  })();
  </script>
</body>
</html>
