<!DOCTYPE html>
<html lang="de-CH">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vorlese-App ‚Äì Lesefluss (Frontend)</title>

  <style>
    @font-face{
      font-family:"Deutschschweizer Basisschrift";
      src:
        url("./fonts/DeutschschweizerBasisschrift.ttf") format("truetype"),
        url("./fonts/DeutschschweizerBasisschrift.otf") format("opentype");
      font-weight:400;
      font-style:normal;
      font-display:swap;
    }

    :root{
      --bg:#0b1220;
      --text:#e7eefc;
      --muted:#a9b7d6;
      --ok:#39d98a;
      --bad:#ff5c7a;
      --accent:#7aa2ff;
      --border:rgba(255,255,255,.12);
      --shadow:0 16px 40px rgba(0,0,0,.35);
      --radius:16px;

      font-family:
        "Deutschschweizer Basisschrift",
        system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    html,body{height:100%;}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(122,162,255,.18), transparent 55%),
                  radial-gradient(900px 700px at 90% 30%, rgba(57,217,138,.12), transparent 55%),
                  radial-gradient(900px 700px at 30% 95%, rgba(255,92,122,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      box-sizing:border-box;
    }
    .app{width:min(1100px, 100%); display:grid; gap:14px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px;}
    .badge{
      font-size:12px; padding:3px 8px; border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(0,0,0,.18);
    }
    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .section{padding:16px; display:grid; gap:14px;}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
    .grid{display:grid; gap:12px; grid-template-columns: repeat(12, 1fr);}
    .col-6{grid-column: span 6;}
    .col-12{grid-column: span 12;}
    @media (max-width: 860px){ .col-6{grid-column: span 12;} }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      user-select:none;
      transition:transform .04s ease, background .12s ease, border-color .12s ease;
      font-family: inherit;
      font-size:16px;
    }
    .btn:active{transform:translateY(1px);}
    .btn.primary{
      background:linear-gradient(180deg, rgba(122,162,255,.30), rgba(122,162,255,.14));
      border-color:rgba(122,162,255,.45);
    }
    .btn.ok{
      background:linear-gradient(180deg, rgba(57,217,138,.26), rgba(57,217,138,.12));
      border-color:rgba(57,217,138,.42);
    }
    .btn.bad{
      background:linear-gradient(180deg, rgba(255,92,122,.22), rgba(255,92,122,.10));
      border-color:rgba(255,92,122,.40);
    }
    .btn.ghost{background:transparent;}
    .btn[disabled]{opacity:.55; cursor:not-allowed;}
    .btn.big{padding:14px 16px; font-size:18px; border-radius:16px;}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.16);
      color:var(--muted);
      font-size:13px;
    }

    /* ‚úÖ Aufgabe + erkannter Text: volle Breite, 1 Zeile, Auto-Fit via JS */
    .lineBox{
      width:100%;
      box-sizing:border-box;
      display:block;

      font-size:58px;          /* Startwert ‚Äì JS verkleinert bei Bedarf */
      font-weight:900;
      line-height:1.15;
      letter-spacing:.2px;
      padding:14px 16px;
      border-radius:16px;
      font-family: inherit;

      white-space:nowrap;      /* immer 1 Zeile */
      overflow:hidden;         /* falls JS noch fitten muss */
      text-overflow:clip;      /* NICHT ellipsis */
    }

    .bigTarget{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
      color:var(--text);
    }

    .spokenNormBig{
      border:1px dashed rgba(122,162,255,.55);
      background:rgba(122,162,255,.08);
      color:var(--accent);
      min-height: 1.15em;
    }

    .feedback{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.16);
      font-weight:900;
      letter-spacing:.2px;
      font-size:16px;
    }
    .feedback.ok{border-color:rgba(57,217,138,.45); background:rgba(57,217,138,.12); color:#dfffea;}
    .feedback.bad{border-color:rgba(255,92,122,.45); background:rgba(255,92,122,.10); color:#ffe2e8;}
    .hidden{display:none !important;}
    .divider{height:1px; background:var(--border); margin:6px 0;}
    .footerNote{font-size:12px; color:var(--muted); line-height:1.35;}
    .muted{color:var(--muted);}

    /* Info button + overlay */
    .infoBtn{
      width:44px;height:44px;border-radius:999px;
      border:1px solid rgba(122,162,255,.55);
      background:linear-gradient(180deg, rgba(122,162,255,.38), rgba(122,162,255,.18));
      color:#fff;font-weight:1000;
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;user-select:none;
      box-shadow:0 10px 26px rgba(0,0,0,.30);
    }
    .infoBtn:active{transform:translateY(1px);}
    .infoBtn span{font-size:18px; line-height:1; transform:translateY(-1px);}

    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:50;
    }
    .overlay.open{display:flex;}
    .drawer{
      width:min(980px, 100%);
      border:1px solid var(--border);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(16,26,46,.98), rgba(7,12,22,.96));
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      padding:14px;
      display:grid;
      gap:12px;
    }
    .drawerHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .drawerTitle{font-weight:1000; letter-spacing:.2px; display:flex; align-items:center; gap:10px;}
    .drawerTitle .mini{font-size:12px; color:var(--muted); font-weight:700;}
    .closeBtn{
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      font-family:inherit;
    }

    /* Start screen */
    .modeRow{display:flex; gap:12px; flex-wrap:wrap;}
    .modeRow .btn{flex:1 1 220px;}
    .levelRow{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;}
    @media (max-width: 720px){ .levelRow{grid-template-columns: 1fr;} }
    .selected{
      outline:2px solid rgba(122,162,255,.55);
      border-color:rgba(122,162,255,.65) !important;
      background:linear-gradient(180deg, rgba(122,162,255,.32), rgba(122,162,255,.16)) !important;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <span>üìñ Vorlese-App</span>
        <span class="badge">20 Aufgaben</span>
      </div>
      <div class="row" style="gap:12px;">
        <span class="badge" id="srBadge">üéôÔ∏è ‚Ä¶</span>
        <button id="btnInfo" class="infoBtn" aria-label="Info"><span>I</span></button>
      </div>
    </div>

    <!-- START -->
    <div id="screenStart" class="card">
      <div class="section">
        <div class="muted" style="font-size:14px;font-weight:900;">W√§hle aus:</div>

        <div>
          <div class="muted" style="margin-bottom:8px;font-weight:900;">Modus</div>
          <div class="modeRow">
            <button id="btnModeWords" class="btn big selected" type="button">W√∂rter</button>
            <button id="btnModeSent" class="btn big" type="button">S√§tze</button>
          </div>
        </div>

        <div>
          <div class="muted" style="margin-bottom:8px;font-weight:900;">Schwierigkeit</div>
          <div class="levelRow">
            <button id="btnLvlEasy" class="btn big selected" type="button">einfach<br><span class="muted" style="font-weight:900;">1. Klasse</span></button>
            <button id="btnLvlMed" class="btn big" type="button">mittel<br><span class="muted" style="font-weight:900;">2. Klasse</span></button>
            <button id="btnLvlHard" class="btn big" type="button">schwierig<br><span class="muted" style="font-weight:900;">3. Klasse</span></button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button id="btnStart" class="btn primary big">Start</button>
        </div>

        <div class="footerNote">Tipp: üé§ Sprechen ‚Üí laut lesen ‚Üí √úberpr√ºfen.</div>
      </div>
    </div>

    <!-- QUIZ -->
    <div id="screenQuiz" class="card hidden">
      <div class="section">
        <div class="row" style="justify-content:space-between;">
          <span class="pill">üìå <b id="progressText">Aufgabe 1 von 20</b></span>
          <span class="pill">‚úÖ richtig: <b id="rightCount">0</b> ‚Ä¢ ‚ùå falsch: <b id="wrongCount">0</b></span>
        </div>

        <!-- ‚úÖ volle Breite / eigene Zeile -->
        <div id="targetBox" class="lineBox bigTarget">‚Ä¶</div>

        <!-- ‚úÖ volle Breite / eigene Zeile darunter -->
        <div id="spokenNormBig" class="lineBox spokenNormBig"> </div>

        <!-- Buttons darunter -->
        <div class="row">
          <button id="btnMic" class="btn ok big">üé§ Sprechen</button>
          <button id="btnCheck" class="btn primary big">√úberpr√ºfen</button>
          <button id="btnNext" class="btn ghost big" disabled>N√§chste</button>
        </div>

        <div id="fallbackWrap" class="grid hidden">
          <div class="col-12">
            <div class="feedback bad">Spracherkennung ist nicht verf√ºgbar. Bitte Text eingeben.</div>
          </div>
          <div class="col-12">
            <label for="fallbackInput">Eingabe</label>
            <input id="fallbackInput" type="text" placeholder="Gelesenen Text eingeben‚Ä¶" />
          </div>
        </div>

        <div class="col-12">
          <div id="feedback" class="feedback">Bereit.</div>
        </div>
      </div>
    </div>

    <!-- RESULT -->
    <div id="screenResult" class="card hidden">
      <div class="section">
        <div class="row" style="justify-content:space-between;">
          <span class="pill">üèÅ <b>Ergebnis</b></span>
          <span class="pill">20 Aufgaben</span>
        </div>

        <div class="row" style="gap:12px; flex-wrap:wrap;">
          <div class="pill" style="font-size:15px;">‚úÖ Richtig: <b id="resRight">0</b></div>
          <div class="pill" style="font-size:15px;">‚ùå Falsch: <b id="resWrong">0</b></div>
        </div>

        <div class="row">
          <button id="btnDone" class="btn primary big">Fertig</button>
          <button id="btnPractice" class="btn ghost big">Weiter √ºben</button>
        </div>
      </div>
    </div>

    <!-- TEACHER INFO -->
    <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-label="Info">
      <div class="drawer">
        <div class="drawerHeader">
          <div class="drawerTitle">
            <span>‚ÑπÔ∏è Info & Einstellungen</span>
            <span class="mini">(f√ºr Lehrpersonen)</span>
          </div>
          <button id="btnCloseInfo" class="closeBtn" type="button">Schliessen</button>
        </div>

        <div class="grid">
          <div class="col-6">
            <label for="orderSel">Reihenfolge</label>
            <select id="orderSel">
              <option value="random">Zuf√§llig</option>
              <option value="inorder">In Reihenfolge</option>
            </select>
          </div>

          <div class="col-6">
            <label>Audio</label>
            <div class="footerNote">
              Fix: <b>/audio/correct.wav</b>, <b>/audio/error.wav</b>, <b>/audio/gamewon.wav</b>
            </div>
          </div>

          <div class="col-6">
            <label>Vergleich</label>
            <label class="pill" style="cursor:pointer; width:fit-content;">
              <input id="removeFillers" type="checkbox" checked style="transform:translateY(1px);" />
              F√ºllw√∂rter entfernen
            </label>
          </div>

          <div class="col-6">
            <label>Feedback</label>
            <label class="pill" style="cursor:pointer; width:fit-content;">
              <input id="showExpectedOnFail" type="checkbox" />
              Bei Fehler ‚ÄûRichtig w√§re ‚Ä¶‚Äú anzeigen
            </label>
          </div>

          <div class="col-12">
            <div class="divider"></div>
            <div class="footerNote">
              Wortlisten sind fix implementiert (1.‚Äì3. Klasse). Spracherkennung: <b>de-CH</b>. Normalisierung: deterministisch <b>√ü ‚Üí ss</b>.
            </div>
            <div class="footerNote">
              LearningView Abschluss: <b>window.parent.postMessage("AppSolved","*")</b>
            </div>
            <div class="footerNote">
              SpeechRecognition: <b id="srAvail">‚Äî</b>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
  (function(){
    "use strict";

    const SR_LANG = "de-CH";
    const TASKS_TOTAL = 20;
    const FILLERS = new Set(["√§h","√§hm","also","und","bitte","ja","genau"]);

    const AUDIO_OK_URL  = "/audio/correct.wav";
    const AUDIO_BAD_URL = "/audio/error.wav";
    const AUDIO_WON_URL = "/audio/gamewon.wav";
    const SILENCE_MS = 900;

    // ===== Auto-Fit: 1 Zeile, volle Breite, vollst√§ndig sichtbar =====
    // (Startwert 58px, Minimum 22px ‚Äì kannst du nach Bedarf anpassen)
    const FIT_MAX_PX = 58;
    const FIT_MIN_PX = 22;

    function fitSingleLine(el, maxPx = FIT_MAX_PX, minPx = FIT_MIN_PX){
      if(!el) return;
      // leere Inhalte nicht fitten
      const txt = (el.textContent || "").trim();
      if(!txt){
        el.style.fontSize = maxPx + "px";
        return;
      }

      // Reset auf max
      el.style.fontSize = maxPx + "px";

      // Wenn passt: fertig
      if(el.scrollWidth <= el.clientWidth) return;

      // Binary search zwischen min..max
      let lo = minPx, hi = maxPx, best = minPx;
      while(lo <= hi){
        const mid = Math.floor((lo + hi) / 2);
        el.style.fontSize = mid + "px";
        if(el.scrollWidth <= el.clientWidth){
          best = mid;
          lo = mid + 1;
        }else{
          hi = mid - 1;
        }
      }
      el.style.fontSize = best + "px";
    }

    function fitBoth(){
      fitSingleLine(targetBox);
      fitSingleLine(spokenNormBig);
    }

    // =========================
    // WORD LISTS
    // =========================
    const WORDS_LVL1 = [
      "Hund","Katze","Maus","Frosch","Vogel","Fisch","B√§r","Wolf","Haus","Wald",
      "Weg","Baum","Mond","Sonne","Stern","Brot","Apfel","Suppe","Ball","Boot",
      "Bus","Auto","Bett","Uhr","Regen",
      "rennt","l√§uft","springt","fliegt","sitzt","steht","ruft","sieht","h√∂rt","isst",
      "trinkt","f√§llt","rollt","kommt","geht","bleibt","schl√§ft","wacht","f√§hrt","sucht",
      "findet","nimmt","gibt","√∂ffnet","schliesst"
    ];

    const WORDS_LVL2 = [
      "Freund","Freundin","Bande","Geheimnis","Rucksack","Schulhof","Klassenzimmer","Fahrrad","Taschenlampe","Regenjacke",
      "Hund","Katze","Pferd","Vogel","Baum","Garten","Strasse","Br√ºcke","Fenster","Keller",
      "schleichen","rennen","fl√ºstern","lachen","staunen","stolpern","verstecken","warten","suchen","finden",
      "spannend","geheim","dunkel","hell","leise","laut","nass","mutig","neugierig","nerv√∂s",
      "pl√∂tzlich","langsam","schnell","draussen","drinnen","vorne","hinten","oben","unten","heute"
    ];

    const WORDS_LVL3 = [
      "Schulhofeingang","Klassenzimmert√ºr","Taschenlampenlicht","Fahrradklingel","Regenpf√ºtzenrand",
      "Kellerfensterrahmen","Baumhausleiter","Waldwegkurve","Geheimversteck","Detektivbande",
      "Freundschaftsprobe","Mutprobe","Stimmengewirr","T√ºrknarren","Schattenspiel",
      "Nachtger√§usch","Windb√∂enrauschen","Regenjackentasche","Turnhallenecke","Pausenglockenl√§uten",
      "Rucksackinhalt","Schulranzenboden","Taschenmessergriff","Fahrradkettenklackern","Pflastersteinrand",
      "Gartenzaunl√ºcke","Hinterhofeingang","Kellerstufengel√§nder","Fensterbankkante","T√ºrspaltlicht",
      "Fl√ºstergespr√§ch","Schreckmoment","√úberraschungsfund","Abenteuerbeginn","Spurenfolge",
      "R√§tselaufgabe","Verdachtspunkt","Plan√§nderung","Verfolgungsspur","Treffpunktvereinbarung",
      "R√ºckzugsort","Beobachtungsposten","Taschenlampenbatterie","Zeitdruckgef√ºhl","Versteckspiel",
      "Freundschaftsb√ºndnis","Angstmoment","Erleichterungsseufzer","Abschlusslachen","Heimwegentscheidung"
    ];

    const SENT_LVL1 = [
      "Mama isst Brot.","Papa f√§hrt Auto.","Die Maus rennt.","Der Bus kommt.","Das Haus ist gross.",
      "Die Sonne scheint.","Ich sehe Meer.","Der Vogel fliegt.","Das Boot schwimmt.","Ich mag Eis.",
      "Oma sitzt da.","Opa liest Buch.","Die Uhr tickt.","Das Bett ist weich.","Der Mond leuchtet.",
      "Die Katze rennt.","Der Hund bellt.","Ich h√∂re Radio.","Das Brot ist warm.","Die Suppe dampft.",
      "Der Ball rollt.","Ich sehe Wald.","Die Wiese ist gr√ºn.","Das Auto steht.","Der Fisch springt.",
      "Mama ruft Papa.","Papa h√∂rt zu.","Ich trinke Tee.","Die Tasse kippt.","Der Teller f√§llt.",
      "Das Glas ist leer.","Die T√ºr geht auf.","Ich renne weg.","Wir sind da.","Das Licht geht aus.",
      "Ich liege im Bett.","Die Uhr klingelt.","Die Sonne geht auf.","Der Mond geht hoch.","Ich sehe nichts.",
      "Der Weg ist lang.","Wir gehen heim.","Das Haus schl√§ft.","Die Maus frisst Brot.","Der Vogel singt.",
      "Das Eis schmilzt.","Ich h√∂re nichts.","Der Bus f√§hrt weg.","Das Boot kippt fast.","Ich bin m√ºde."
    ];

    const SENT_LVL2 = [
      "Der Ball fliegt √ºber den Zaun.","Wir sitzen im Zimmer.","Die Sonne blendet mich.","In der Schule ist es laut.",
      "Die Klasse wartet unruhig.","Der Lehrer kommt sp√§t.","Die Sch√ºlerin meldet sich.","Mein Rucksack ist zu voll.",
      "Die Tasche f√§llt um.","Wir essen zu schnell.","Das Wasser schwappt √ºber.","Der Kaffee ist viel zu heiss.",
      "Das Messer rutscht ab.","Die Gabel liegt daneben.","Der L√∂ffel klappert laut.","Es ist schon Mittag.",
      "Am Nachmittag regnet es.","Am Abend wird es ruhig.","Am Morgen bin ich m√ºde.","Der Himmel wird grau.",
      "Eine Wolke sieht komisch aus.","Der Regen platscht laut.","Die Strasse gl√§nzt nass.","Wir rennen √ºber die Br√ºcke.",
      "Das Fenster klappert im Wind.","Die T√ºre f√§llt zu.","Ich lese heimlich weiter.","Wir schreiben viel zu langsam.",
      "Die Rechnung stimmt nicht.","Die Kinder lachen laut.","Alle rennen durcheinander.","Ich stolpere fast.",
      "Die Katze verschwindet schnell.","Der Hund wartet draussen.","Das Pferd stampft nerv√∂s.","Mein Freund ruft mich.",
      "Die Freundin winkt kurz.","Die Familie sitzt zusammen.","Im Garten ist es still.","Eine Blume ist kaputt.",
      "Der Baum knackt laut.","Die Wiese ist nass.","Ein Vogel flattert weg.","Die Katze beobachtet alles.",
      "Der Hund zieht an der Leine.","Das Pferd schnaubt laut.","Ich h√∂re Schritte.","Wir verstecken uns schnell.",
      "Alle schauen gespannt.","Dann wird es still."
    ];

    const SENT_LVL3 = [
      "Greg schloss die T√ºr, weil es draussen laut war.",
      "Wir standen still, als jemand rief.",
      "Ich drehte mich um, obwohl ich Angst hatte.",
      "Der Ball rollte weiter, bis er im Geb√ºsch lag.",
      "Sie fl√ºsterten leise, damit niemand sie h√∂rte.",
      "Tom grinste, w√§hrend er den Plan erkl√§rte.",
      "Wir warteten kurz, bevor wir losrannten.",
      "Das Fahrrad kippte um, als der Weg rutschig wurde.",
      "Ich blieb stehen, weil etwas raschelte.",
      "Sie lachten laut, obwohl es unpassend war.",
      "Der Hund bellte, als die T√ºr aufging.",
      "Wir duckten uns, sobald Schritte kamen.",
      "Der Rucksack riss, weil er zu schwer war.",
      "Ich sah nach oben, w√§hrend der Ball flog.",
      "Sie fluchten leise, nachdem alles schiefging.",
      "Wir rannten los, als das Signal kam.",
      "Der Regen h√∂rte auf, bevor wir ankamen.",
      "Ich tat so, als w√§re nichts passiert.",
      "Sie tuschelten, obwohl alle zuh√∂rten.",
      "Der Plan klang gut, bis jemand widersprach.",
      "Wir gingen weiter, obwohl der Weg dunkel war.",
      "Er stolperte, weil er nicht aufpasste.",
      "Ich hielt den Atem an, als es krachte.",
      "Sie schauten sich an, w√§hrend niemand sprach.",
      "Der Hund sprang vor, sobald die T√ºr offen war.",
      "Wir versteckten uns, als das Licht anging.",
      "Ich drehte mich um, weil jemand lachte.",
      "Sie blieben stehen, obwohl sie rennen wollten.",
      "Der Ball verschwand, nachdem er √ºberrollte.",
      "Wir h√∂rten Stimmen, w√§hrend wir warteten.",
      "Ich schloss die Augen, als es laut knallte.",
      "Sie grinste, obwohl sie nichts sagte.",
      "Wir duckten uns, bevor jemand kam.",
      "Der Wind pfiff, w√§hrend wir weitergingen.",
      "Ich rannte los, als alle schauten.",
      "Sie blieben ruhig, obwohl Chaos herrschte.",
      "Der Hund folgte uns, bis wir verschwanden.",
      "Wir h√∂rten auf, als es still wurde.",
      "Ich schaute zur√ºck, w√§hrend sie winkten.",
      "Sie lachten wieder, nachdem alles vorbei war.",
      "Der Plan √§nderte sich, weil etwas fehlte.",
      "Wir warteten draussen, bis es dunkel wurde.",
      "Ich fl√ºsterte, damit niemand uns h√∂rte.",
      "Sie rannten weiter, obwohl sie m√ºde waren.",
      "Der Ball tauchte wieder auf, als niemand rechnete.",
      "Wir gingen langsam, weil der Boden nass war.",
      "Ich nickte, obwohl ich zweifelte.",
      "Sie schauten weg, als es peinlich wurde.",
      "Wir blieben stehen, bis alles ruhig war.",
      "Dann gingen wir weiter, als w√§re nichts gewesen."
    ];

    // =========================
    // DOM
    // =========================
    const el = (id)=>document.getElementById(id);

    const screenStart = el("screenStart");
    const screenQuiz = el("screenQuiz");
    const screenResult = el("screenResult");

    const btnModeWords = el("btnModeWords");
    const btnModeSent = el("btnModeSent");

    const btnLvlEasy = el("btnLvlEasy");
    const btnLvlMed  = el("btnLvlMed");
    const btnLvlHard = el("btnLvlHard");

    const btnStart = el("btnStart");

    const progressText = el("progressText");
    const targetBox = el("targetBox");
    const spokenNormBig = el("spokenNormBig");

    const btnMic = el("btnMic");
    const btnCheck = el("btnCheck");
    const btnNext = el("btnNext");

    const feedback = el("feedback");
    const rightCount = el("rightCount");
    const wrongCount = el("wrongCount");

    const fallbackWrap = el("fallbackWrap");
    const fallbackInput = el("fallbackInput");

    const resRight = el("resRight");
    const resWrong = el("resWrong");
    const btnDone = el("btnDone");
    const btnPractice = el("btnPractice");

    const srBadge = el("srBadge");
    const srAvail = el("srAvail");

    const overlay = el("overlay");
    const btnInfo = el("btnInfo");
    const btnCloseInfo = el("btnCloseInfo");

    const orderSel = el("orderSel");
    const removeFillers = el("removeFillers");
    const showExpectedOnFail = el("showExpectedOnFail");

    // =========================
    // Student UI state
    // =========================
    let uiMode = "words";
    let uiLevel = "easy";

    function setMode(mode){
      uiMode = mode;
      btnModeWords.classList.toggle("selected", mode === "words");
      btnModeSent.classList.toggle("selected", mode === "sentences");
    }
    function setLevel(level){
      uiLevel = level;
      btnLvlEasy.classList.toggle("selected", level === "easy");
      btnLvlMed.classList.toggle("selected", level === "med");
      btnLvlHard.classList.toggle("selected", level === "hard");
    }

    setMode("words");
    setLevel("easy");

    btnModeWords.addEventListener("click", ()=>setMode("words"));
    btnModeSent.addEventListener("click", ()=>setMode("sentences"));
    btnLvlEasy.addEventListener("click", ()=>setLevel("easy"));
    btnLvlMed.addEventListener("click", ()=>setLevel("med"));
    btnLvlHard.addEventListener("click", ()=>setLevel("hard"));

    // =========================
    // Audio
    // =========================
    let audioOk = null, audioBad = null, audioWon = null;

    function initAudio(){
      audioOk  = new Audio(AUDIO_OK_URL);
      audioBad = new Audio(AUDIO_BAD_URL);
      audioWon = new Audio(AUDIO_WON_URL);
    }
    function play(a){
      if(!a) return;
      try{ a.currentTime = 0; a.play(); }catch(_){}
    }
    function playOk(){ if(!audioOk) initAudio(); play(audioOk); }
    function playBad(){ if(!audioBad) initAudio(); play(audioBad); }
    function playWon(){ if(!audioWon) initAudio(); play(audioWon); }

    // =========================
    // SpeechRecognition
    // =========================
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const hasSR = !!SR;

    srBadge.textContent = hasSR ? "üéôÔ∏è bereit" : "üéôÔ∏è nicht verf√ºgbar";
    srAvail.textContent = hasSR ? "verf√ºgbar" : "nicht verf√ºgbar";

    let recognition = null;
    let isListening = false;

    let speechBuffer = "";
    let finalChunks = [];
    let silenceTimer = null;
    let hadFinalChunk = false;

    function setupRecognition(){
      if(!hasSR) return;

      recognition = new SR();
      recognition.lang = SR_LANG;
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.maxAlternatives = 8;

      recognition.onresult = (event)=>{
        let interimText = "";
        for(let i = event.resultIndex; i < event.results.length; i++){
          const res = event.results[i];
          const transcript = (res && res[0] ? res[0].transcript : "").trim();
          if(!transcript) continue;

          if(res.isFinal){
            const last = finalChunks.length ? finalChunks[finalChunks.length-1] : "";
            if(transcript !== last){
              finalChunks.push(transcript);
              if(finalChunks.length > 40) finalChunks = finalChunks.slice(-40);
              if(speechBuffer) speechBuffer += " ";
              speechBuffer += transcript;
              hadFinalChunk = true;
            }
          }else{
            interimText = transcript;
          }
        }

        const combined = (speechBuffer + (interimText ? (" " + interimText) : "")).trim();
        const shown = normalizeText(combined, {removeFillers: removeFillers.checked});
        spokenNormBig.textContent = shown || " ";

        // ‚úÖ immer fitten (1 Zeile, volle Breite)
        fitBoth();

        restartSilenceTimer();
      };

      recognition.onerror = ()=>{
        setFeedback("Fehler bei der Spracherkennung.", "bad");
        stopListening(true);
      };

      recognition.onend = ()=>{
        isListening = false;
        updateMicButton();
        clearSilenceTimer();
      };
    }

    function restartSilenceTimer(){
      if(!hasSR) return;
      clearSilenceTimer();
      silenceTimer = setTimeout(()=>{
        if(isListening && hadFinalChunk){
          stopListening(false);
        }
      }, SILENCE_MS);
    }
    function clearSilenceTimer(){
      if(silenceTimer){
        clearTimeout(silenceTimer);
        silenceTimer = null;
      }
    }

    function startListening(){
      if(!hasSR || !recognition) return;

      speechBuffer = "";
      finalChunks = [];
      hadFinalChunk = false;

      spokenNormBig.textContent = " ";
      fitBoth();

      recognition.lang = SR_LANG;

      try{
        recognition.start();
        isListening = true;
        updateMicButton();
        setFeedback("Sprich jetzt.", "");
        restartSilenceTimer();
      }catch(_){
        setFeedback("Spracherkennung konnte nicht gestartet werden.", "bad");
        isListening = false;
        updateMicButton();
      }
    }

    function stopListening(){
      if(!hasSR || !recognition) return;
      try{ recognition.stop(); }catch(_){}
      isListening = false;
      updateMicButton();
      clearSilenceTimer();
    }

    function toggleListening(){
      if(!hasSR) return;
      if(!recognition) setupRecognition();
      if(!audioOk || !audioBad || !audioWon) initAudio();
      if(isListening) stopListening();
      else startListening();
    }

    function updateMicButton(){
      btnMic.textContent = isListening ? "‚èπÔ∏è Stop" : "üé§ Sprechen";
      btnMic.classList.toggle("bad", isListening);
      btnMic.classList.toggle("ok", !isListening);
      srBadge.textContent = hasSR ? (isListening ? "üéôÔ∏è h√∂rt zu‚Ä¶" : "üéôÔ∏è bereit") : "üéôÔ∏è nicht verf√ºgbar";
    }

    // =========================
    // Normalization & Matching
    // =========================
    function normalizeText(s, opts){
      const remove = !!(opts && opts.removeFillers);
      let t = (s || "").toLowerCase();

      try{
        t = t.replace(/[^\p{L}\p{N}\s]/gu, " ");
      }catch(_){
        t = t.replace(/[^a-z0-9√§√∂√º√ü\s]/gi, " ");
      }

      t = t.replace(/\s+/g, " ").trim();
      t = t.replace(/√ü/g, "ss");

      if(remove){
        const parts = t.split(" ").filter(Boolean).filter(w => !FILLERS.has(w));
        t = parts.join(" ");
      }
      return t;
    }

    function tokenize(norm){
      return (norm ? norm.split(" ").filter(Boolean) : []);
    }
    function escapeRegex(s){
      return (s || "").replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }
    function containsWholeWordToken(spokenNorm, targetNorm){
      const w = targetNorm.trim();
      if(!w) return false;
      const re = new RegExp("(^|\\s)" + escapeRegex(w) + "($|\\s)");
      return re.test(spokenNorm);
    }
    function isSubsequenceMatch(targetTokens, spokenTokens, threshold){
      if(targetTokens.length === 0) return false;
      let i = 0;
      for(let j = 0; j < spokenTokens.length && i < targetTokens.length; j++){
        if(spokenTokens[j] === targetTokens[i]) i++;
      }
      return (i / targetTokens.length) >= threshold;
    }

    function compareDeterministic(targetText, spokenTextRaw, mode){
      const tNorm = normalizeText(targetText, {removeFillers: removeFillers.checked});
      const sNorm = normalizeText(spokenTextRaw, {removeFillers: removeFillers.checked});

      if(!tNorm) return {ok:false, spokenNorm:sNorm, targetNorm:tNorm};
      if(!sNorm) return {ok:false, spokenNorm:sNorm, targetNorm:tNorm};

      if(mode === "words"){
        const tTokens = tokenize(tNorm);
        if(tTokens.length === 1){
          return {ok: containsWholeWordToken(sNorm, tNorm), spokenNorm:sNorm, targetNorm:tNorm};
        }
        return {ok: isSubsequenceMatch(tTokens, tokenize(sNorm), 1.0), spokenNorm:sNorm, targetNorm:tNorm};
      }

      const longerIsSpoken = sNorm.length >= tNorm.length;
      if(longerIsSpoken && sNorm.includes(tNorm)) return {ok:true, spokenNorm:sNorm, targetNorm:tNorm};
      if(!longerIsSpoken && tNorm.includes(sNorm)) return {ok:true, spokenNorm:sNorm, targetNorm:tNorm};

      return {ok: isSubsequenceMatch(tokenize(tNorm), tokenize(sNorm), 0.90), spokenNorm:sNorm, targetNorm:tNorm};
    }

    // =========================
    // RISKY WORD FILTER
    // =========================
    const RISKY_WORDS = new Set([
      "starren","starrten","starre",
      "starten","startete","startet",
      "mehr","meer",
      "seit","seid",
      "das","dass",
      "wieder","wider",
      "leere","lehre",
      "wahr","war",
      "wen","wenn",
      "weg","weck",
      "denn","wenn"
    ]);

    function isSafeItem(text){
      const norm = normalizeText(text, { removeFillers: false });
      if(!norm) return false;
      const toks = tokenize(norm);
      for(const w of toks){
        if(RISKY_WORDS.has(w)) return false;
      }
      return true;
    }

    // =========================
    // Run state
    // =========================
    let run = null;

    function buildPool(){
      let pool;
      if(uiMode === "words"){
        if(uiLevel === "easy") pool = WORDS_LVL1.slice();
        else if(uiLevel === "med") pool = WORDS_LVL2.slice();
        else pool = WORDS_LVL3.slice();
      }else{
        if(uiLevel === "easy") pool = SENT_LVL1.slice();
        else if(uiLevel === "med") pool = SENT_LVL2.slice();
        else pool = SENT_LVL3.slice();
      }
      pool = pool.filter(isSafeItem);
      return pool;
    }

    function shuffleInPlace(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function startRun(){
      const pool = buildPool();
      const items = pool.slice();
      if(orderSel.value === "random") shuffleInPlace(items);

      run = {
        mode: uiMode,
        items,
        index: 0,
        right: 0,
        wrong: 0,
        checked: false,
        lastTarget: ""
      };

      if(hasSR && !recognition) setupRecognition();
      if(!audioOk || !audioBad || !audioWon) initAudio();

      goQuiz();
      loadTask();
    }

    function goStart(){
      screenStart.classList.remove("hidden");
      screenQuiz.classList.add("hidden");
      screenResult.classList.add("hidden");
      if(isListening) stopListening();
    }
    function goQuiz(){
      screenStart.classList.add("hidden");
      screenQuiz.classList.remove("hidden");
      screenResult.classList.add("hidden");
    }
    function goResult(){
      screenStart.classList.add("hidden");
      screenQuiz.classList.add("hidden");
      screenResult.classList.remove("hidden");
      if(isListening) stopListening();

      resRight.textContent = String(run ? run.right : 0);
      resWrong.textContent = String(run ? run.wrong : 0);

      if(run && run.right === TASKS_TOTAL && run.wrong === 0){
        playWon();
      }
    }

    function setFeedback(text, kind){
      feedback.textContent = text;
      feedback.classList.remove("ok","bad");
      if(kind === "ok") feedback.classList.add("ok");
      if(kind === "bad") feedback.classList.add("bad");
    }

    function updateCounts(){
      rightCount.textContent = String(run ? run.right : 0);
      wrongCount.textContent = String(run ? run.wrong : 0);
    }

    function loadTask(){
      if(!run) return;
      if(run.index >= TASKS_TOTAL){
        goResult();
        return;
      }

      run.lastTarget = run.items[run.index];

      progressText.textContent = `Aufgabe ${run.index + 1} von ${TASKS_TOTAL}`;
      targetBox.textContent = run.lastTarget;

      spokenNormBig.textContent = " ";
      setFeedback("Bereit.", "");
      run.checked = false;

      speechBuffer = "";
      finalChunks = [];
      hadFinalChunk = false;

      btnNext.disabled = true;

      if(!hasSR){
        fallbackWrap.classList.remove("hidden");
        fallbackInput.value = "";
      }else{
        fallbackWrap.classList.add("hidden");
      }

      updateCounts();

      // ‚úÖ nach Textwechsel fitten
      requestAnimationFrame(fitBoth);
    }

    function getSpokenRawForCheck(){
      if(!hasSR) return (fallbackInput.value || "").trim();
      return (speechBuffer || "").trim();
    }

    function doCheck(){
      if(!run) return;
      if(!audioOk || !audioBad || !audioWon) initAudio();

      if(isListening) stopListening();

      const spokenRaw = getSpokenRawForCheck();
      const cmp = compareDeterministic(run.lastTarget, spokenRaw, run.mode);

      spokenNormBig.textContent = cmp.spokenNorm || " ";
      requestAnimationFrame(fitBoth);

      if(cmp.ok){
        run.right++;
        setFeedback("Richtig ‚úÖ", "ok");
        playOk();
      }else{
        run.wrong++;
        const extra = showExpectedOnFail.checked ? `  Richtig w√§re: ${run.lastTarget}` : "";
        setFeedback("Falsch ‚ùå" + extra, "bad");
        playBad();
      }

      run.checked = true;
      btnNext.disabled = false;
      updateCounts();
    }

    function doNext(){
      if(!run || !run.checked) return;
      run.index++;
      loadTask();
    }

    function doDone(){
      try{ window.parent.postMessage("AppSolved","*"); }catch(_){}
    }

    // =========================
    // Teacher drawer
    // =========================
    function openInfo(){ overlay.classList.add("open"); }
    function closeInfo(){ overlay.classList.remove("open"); }

    btnInfo.addEventListener("click", openInfo);
    btnCloseInfo.addEventListener("click", closeInfo);
    overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeInfo(); });
    window.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && overlay.classList.contains("open")) closeInfo(); });

    // =========================
    // Buttons
    // =========================
    btnStart.addEventListener("click", startRun);

    btnMic.addEventListener("click", ()=>{
      if(!hasSR){
        setFeedback("Spracherkennung ist nicht verf√ºgbar. Nutze das Eingabefeld.", "bad");
        return;
      }
      toggleListening();
    });

    btnCheck.addEventListener("click", doCheck);
    btnNext.addEventListener("click", doNext);

    btnDone.addEventListener("click", doDone);
    btnPractice.addEventListener("click", ()=>{
      run = null;
      goStart();
    });

    // ‚úÖ bei Resize neu fitten (z.B. Vollbild / Tablet drehen)
    window.addEventListener("resize", ()=>requestAnimationFrame(fitBoth));

    // Init
    if(!hasSR) fallbackWrap.classList.remove("hidden");
    goStart();
    updateMicButton();
    spokenNormBig.textContent = " ";
    requestAnimationFrame(fitBoth);
  })();
  </script>
</body>
</html>
