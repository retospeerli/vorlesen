<!DOCTYPE html>
<html lang="de-CH">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vorlese-App ‚Äì Lesefluss</title>

  <style>
    @font-face{
      font-family:"Deutschschweizer Basisschrift";
      src:
        url("./fonts/DeutschschweizerBasisschrift.ttf") format("truetype"),
        url("./fonts/DeutschschweizerBasisschrift.otf") format("opentype");
      font-weight:400;
      font-style:normal;
      font-display:swap;
    }

    :root{
      --bg:#0b1220;
      --text:#e7eefc;
      --muted:#a9b7d6;
      --ok:#39d98a;
      --bad:#ff5c7a;
      --accent:#7aa2ff;
      --border:rgba(255,255,255,.12);
      --shadow:0 16px 40px rgba(0,0,0,.35);
      --radius:16px;

      font-family:"Deutschschweizer Basisschrift",
        system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    }

    html,body{height:100%;}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(122,162,255,.18), transparent 55%),
                  radial-gradient(900px 700px at 90% 30%, rgba(57,217,138,.12), transparent 55%),
                  radial-gradient(900px 700px at 30% 95%, rgba(255,92,122,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      box-sizing:border-box;
    }

    .app{width:min(1200px,100%); display:grid; gap:14px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px;}
    .badge{
      font-size:12px; padding:4px 10px; border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .section{padding:16px; display:grid; gap:14px;}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.16);
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
    }
    .muted{color:var(--muted);}
    .hidden{display:none !important;}
    .divider{height:1px; background:var(--border); margin:6px 0;}

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      user-select:none;
      font-family:inherit;
      font-size:16px;
      transition:transform .04s ease, background .12s ease, border-color .12s ease;
    }
    .btn:active{transform:translateY(1px);}
    .btn.primary{
      background:linear-gradient(180deg, rgba(122,162,255,.30), rgba(122,162,255,.14));
      border-color:rgba(122,162,255,.45);
    }
    .btn.ok{
      background:linear-gradient(180deg, rgba(57,217,138,.26), rgba(57,217,138,.12));
      border-color:rgba(57,217,138,.42);
    }
    .btn.bad{
      background:linear-gradient(180deg, rgba(255,92,122,.22), rgba(255,92,122,.10));
      border-color:rgba(255,92,122,.40);
    }
    .btn.big{padding:14px 16px; font-size:18px; border-radius:16px;}
    .btn[disabled]{opacity:.55; cursor:not-allowed;}

    /* TARGET gets full width line */
    .lineBox{
      width:100%;
      box-sizing:border-box;
      padding:16px 18px;
      border-radius:18px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
      font-weight:900;
      letter-spacing:.2px;
      line-height:1.12;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size:56px; /* auto-fitted down */
    }
    .spokenLine{
      border:1px dashed rgba(122,162,255,.55);
      background:rgba(122,162,255,.08);
      color:var(--accent);
    }

    .feedback{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.16);
      font-weight:900;
      letter-spacing:.2px;
      font-size:16px;
    }
    .feedback.ok{border-color:rgba(57,217,138,.45); background:rgba(57,217,138,.12); color:#dfffea;}
    .feedback.bad{border-color:rgba(255,92,122,.45); background:rgba(255,92,122,.10); color:#ffe2e8;}

    /* Info button + overlay */
    .infoBtn{
      width:44px;height:44px;border-radius:999px;
      border:1px solid rgba(122,162,255,.55);
      background:linear-gradient(180deg, rgba(122,162,255,.38), rgba(122,162,255,.18));
      color:#fff;font-weight:1000;
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;user-select:none;
      box-shadow:0 10px 26px rgba(0,0,0,.30);
    }
    .infoBtn:active{transform:translateY(1px);}
    .infoBtn span{font-size:18px; line-height:1; transform:translateY(-1px);}

    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:50;
    }
    .overlay.open{display:flex;}
    .drawer{
      width:min(980px, 100%);
      border:1px solid var(--border);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(16,26,46,.98), rgba(7,12,22,.96));
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      padding:14px;
      display:grid;
      gap:12px;
    }
    .drawerHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .drawerTitle{font-weight:1000; letter-spacing:.2px; display:flex; align-items:center; gap:10px;}
    .drawerTitle .mini{font-size:12px; color:var(--muted); font-weight:700;}
    .closeBtn{
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      font-family:inherit;
    }

    /* Start screen */
    .modeRow{display:flex; gap:12px; flex-wrap:wrap;}
    .modeRow .btn{flex:1 1 220px;}
    .levelRow{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;}
    @media (max-width: 720px){ .levelRow{grid-template-columns: 1fr;} }
    .selected{
      outline:2px solid rgba(122,162,255,.55);
      border-color:rgba(122,162,255,.65) !important;
      background:linear-gradient(180deg, rgba(122,162,255,.32), rgba(122,162,255,.16)) !important;
    }

    input[type="text"]{
      width:100%;
      box-sizing:border-box;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.20);
      color:var(--text);
      font-family:inherit;
      font-weight:900;
      font-size:18px;
      outline:none;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <span>üìñ Vorlese-App</span>
        <span class="badge">20 Aufgaben</span>
      </div>
      <div class="row" style="gap:12px;">
        <span class="badge" id="srBadge">üéôÔ∏è ‚Ä¶</span>
        <button id="btnInfo" class="infoBtn" aria-label="Info"><span>I</span></button>
      </div>
    </div>

    <!-- START -->
    <div id="screenStart" class="card">
      <div class="section">
        <div class="muted" style="font-size:14px;font-weight:900;">W√§hle aus:</div>

        <div>
          <div class="muted" style="margin-bottom:8px;font-weight:900;">Modus</div>
          <div class="modeRow">
            <button id="btnModeWords" class="btn big selected" type="button">W√∂rter</button>
            <button id="btnModeSent" class="btn big" type="button">S√§tze</button>
          </div>
        </div>

        <div>
          <div class="muted" style="margin-bottom:8px;font-weight:900;">Schwierigkeit</div>
          <div class="levelRow">
            <button id="btnLvlEasy" class="btn big selected" type="button">einfach<br><span class="muted" style="font-weight:900;">1. Klasse</span></button>
            <button id="btnLvlMed" class="btn big" type="button">mittel<br><span class="muted" style="font-weight:900;">2. Klasse</span></button>
            <button id="btnLvlHard" class="btn big" type="button">schwierig<br><span class="muted" style="font-weight:900;">3. Klasse</span></button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button id="btnStart" class="btn primary big">Start</button>
        </div>

        <div class="muted" style="font-size:12px; line-height:1.35;">
          Ablauf: <b>Sprechen</b> dr√ºcken ‚Üí laut lesen ‚Üí bei kurzer Stille wird automatisch gepr√ºft.
        </div>
      </div>
    </div>

    <!-- QUIZ -->
    <div id="screenQuiz" class="card hidden">
      <div class="section">
        <div class="row" style="justify-content:space-between;">
          <span class="pill">üìå <b id="progressText">Aufgabe 1 von 20</b></span>
          <span class="pill">‚úÖ richtig: <b id="rightCount">0</b> ‚Ä¢ ‚ùå falsch: <b id="wrongCount">0</b></span>
        </div>

        <div id="targetLine" class="lineBox">‚Ä¶</div>
        <div id="spokenLine" class="lineBox spokenLine hidden"></div>

        <div class="row">
          <button id="btnMic" class="btn ok big">üé§ Sprechen</button>
        </div>

        <div id="fallbackWrap" class="hidden">
          <div class="feedback bad">Spracherkennung ist nicht verf√ºgbar. Bitte Text eingeben und ‚ÄûOK‚Äú dr√ºcken.</div>
          <div style="height:10px"></div>
          <input id="fallbackInput" type="text" placeholder="Gelesenen Text eingeben‚Ä¶" />
          <div style="height:10px"></div>
          <button id="btnFallbackOk" class="btn primary big" type="button">OK</button>
        </div>

        <div>
          <div id="feedback" class="feedback">Bereit.</div>
        </div>
      </div>
    </div>

    <!-- RESULT -->
    <div id="screenResult" class="card hidden">
      <div class="section">
        <div class="row" style="justify-content:space-between;">
          <span class="pill">üèÅ <b>Ergebnis</b></span>
          <span class="pill">20 Aufgaben</span>
        </div>

        <div class="row" style="gap:12px; flex-wrap:wrap;">
          <div class="pill" style="font-size:15px;">‚úÖ Richtig: <b id="resRight">0</b></div>
          <div class="pill" style="font-size:15px;">‚ùå Falsch: <b id="resWrong">0</b></div>
        </div>

        <div class="row">
          <button id="btnDone" class="btn primary big">Fertig</button>
          <button id="btnPractice" class="btn big" type="button">Weiter √ºben</button>
        </div>
      </div>
    </div>

    <!-- TEACHER INFO -->
    <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-label="Info">
      <div class="drawer">
        <div class="drawerHeader">
          <div class="drawerTitle">
            <span>‚ÑπÔ∏è Info & Einstellungen</span>
            <span class="mini">(f√ºr Lehrpersonen)</span>
          </div>
          <button id="btnCloseInfo" class="closeBtn" type="button">Schliessen</button>
        </div>

        <div class="row" style="gap:12px; flex-wrap:wrap;">
          <div style="flex:1 1 220px;">
            <div class="muted" style="font-weight:900; margin-bottom:6px;">Reihenfolge</div>
            <select id="orderSel" style="width:100%; padding:12px 12px; border-radius:14px; border:1px solid var(--border); background:rgba(0,0,0,.20); color:var(--text); font-family:inherit; font-weight:900;">
              <option value="random">Zuf√§llig</option>
              <option value="inorder">In Reihenfolge</option>
            </select>
          </div>

          <div style="flex:1 1 220px;">
            <div class="muted" style="font-weight:900; margin-bottom:6px;">Optionen</div>
            <label style="display:flex; gap:10px; align-items:center; padding:12px 12px; border-radius:14px; border:1px solid var(--border); background:rgba(0,0,0,.18);">
              <input id="removeFillers" type="checkbox" checked />
              <span style="font-weight:900;">F√ºllw√∂rter entfernen</span>
            </label>
            <div style="height:10px"></div>
            <label style="display:flex; gap:10px; align-items:center; padding:12px 12px; border-radius:14px; border:1px solid var(--border); background:rgba(0,0,0,.18);">
              <input id="showExpectedOnFail" type="checkbox" />
              <span style="font-weight:900;">Bei Fehler ‚ÄûRichtig w√§re ‚Ä¶‚Äú</span>
            </label>
          </div>
        </div>

        <div class="divider"></div>
        <div class="muted" style="font-size:12px; line-height:1.35;">
          Audio: <b>/audio/correct.wav</b>, <b>/audio/error.wav</b>, <b>/audio/gamewon.wav</b><br>
          Spracherkennung: <b>de-CH</b> ‚Ä¢ Normalisierung: <b>√ü ‚Üí ss</b> ‚Ä¢ Zieltext bleibt exakt wie in den Listen (Gross-/Kleinschreibung).
          <br>SpeechRecognition: <b id="srAvail">‚Äî</b>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    "use strict";

    // ===== Constants =====
    const SR_LANG = "de-CH";
    const TASKS_TOTAL = 20;
    const SILENCE_MS = 900;

    const AUDIO_OK_URL  = "/audio/correct.wav";
    const AUDIO_BAD_URL = "/audio/error.wav";
    const AUDIO_WON_URL = "/audio/gamewon.wav";

    const FILLERS = new Set(["√§h","√§hm","also","und","bitte","ja","genau"]);

    // ===== Lists (case preserved for display!) =====
    const WORDS_LVL1 = [
      "Hund","Katze","Maus","Frosch","Vogel","Fisch","B√§r","Wolf","Haus","Wald",
      "Weg","Baum","Mond","Sonne","Stern","Brot","Apfel","Suppe","Ball","Boot",
      "Bus","Auto","Bett","Uhr","Regen",
      "rennt","l√§uft","springt","fliegt","sitzt","steht","ruft","sieht","h√∂rt","isst",
      "trinkt","f√§llt","rollt","kommt","geht","bleibt","schl√§ft","wacht","f√§hrt","sucht",
      "findet","nimmt","gibt","√∂ffnet","schliesst"
    ];
    const WORDS_LVL2 = [
      "Freund","Freundin","Bande","Geheimnis","Rucksack","Schulhof","Klassenzimmer","Fahrrad","Taschenlampe","Regenjacke",
      "Hund","Katze","Pferd","Vogel","Baum","Garten","Strasse","Br√ºcke","Fenster","Keller",
      "schleichen","rennen","fl√ºstern","lachen","staunen","stolpern","verstecken","warten","suchen","finden",
      "spannend","geheim","dunkel","hell","leise","laut","nass","mutig","neugierig","nerv√∂s",
      "pl√∂tzlich","langsam","schnell","draussen","drinnen","vorne","hinten","oben","unten","heute"
    ];
    const WORDS_LVL3 = [
      "Schulhofeingang","Klassenzimmert√ºr","Taschenlampenlicht","Fahrradklingel","Regenpf√ºtzenrand",
      "Kellerfensterrahmen","Baumhausleiter","Waldwegkurve","Geheimversteck","Detektivbande",
      "Freundschaftsprobe","Mutprobe","Stimmengewirr","T√ºrknarren","Schattenspiel",
      "Nachtger√§usch","Windb√∂enrauschen","Regenjackentasche","Turnhallenecke","Pausenglockenl√§uten",
      "Rucksackinhalt","Schulranzenboden","Taschenmessergriff","Fahrradkettenklackern","Pflastersteinrand",
      "Gartenzaunl√ºcke","Hinterhofeingang","Kellerstufengel√§nder","Fensterbankkante","T√ºrspaltlicht",
      "Fl√ºstergespr√§ch","Schreckmoment","√úberraschungsfund","Abenteuerbeginn","Spurenfolge",
      "R√§tselaufgabe","Verdachtspunkt","Plan√§nderung","Verfolgungsspur","Treffpunktvereinbarung",
      "R√ºckzugsort","Beobachtungsposten","Taschenlampenbatterie","Zeitdruckgef√ºhl","Versteckspiel",
      "Freundschaftsb√ºndnis","Angstmoment","Erleichterungsseufzer","Abschlusslachen","Heimwegentscheidung"
    ];

    const SENT_LVL1 = [
      "Mama isst Brot.","Papa f√§hrt Auto.","Die Maus rennt.","Der Bus kommt.","Das Haus ist gross.","Die Sonne scheint.","Ich sehe Meer.","Der Vogel fliegt.","Das Boot schwimmt.","Ich mag Eis.",
      "Oma sitzt da.","Opa liest Buch.","Die Uhr tickt.","Das Bett ist weich.","Der Mond leuchtet.","Die Katze rennt.","Der Hund bellt.","Ich h√∂re Radio.","Das Brot ist warm.","Die Suppe dampft.",
      "Der Ball rollt.","Ich sehe Wald.","Die Wiese ist gr√ºn.","Das Auto steht.","Der Fisch springt.","Mama ruft Papa.","Papa h√∂rt zu.","Ich trinke Tee.","Die Tasse kippt.","Der Teller f√§llt.",
      "Das Glas ist leer.","Die T√ºr geht auf.","Ich renne weg.","Wir sind da.","Das Licht geht aus.","Ich liege im Bett.","Die Uhr klingelt.","Die Sonne geht auf.","Der Mond geht hoch.","Ich sehe nichts.",
      "Der Weg ist lang.","Wir gehen heim.","Das Haus schl√§ft.","Die Maus frisst Brot.","Der Vogel singt.","Das Eis schmilzt.","Ich h√∂re nichts.","Der Bus f√§hrt weg.","Das Boot kippt fast.","Ich bin m√ºde."
    ];
    const SENT_LVL2 = [
      "Der Ball fliegt √ºber den Zaun.","Wir sitzen im Zimmer.","Die Sonne blendet mich.","In der Schule ist es laut.","Die Klasse wartet unruhig.","Der Lehrer kommt sp√§t.","Die Sch√ºlerin meldet sich.","Mein Rucksack ist zu voll.","Die Tasche f√§llt um.","Wir essen zu schnell.",
      "Das Wasser schwappt √ºber.","Der Kaffee ist viel zu heiss.","Das Messer rutscht ab.","Die Gabel liegt daneben.","Der L√∂ffel klappert laut.","Es ist schon Mittag.","Am Nachmittag regnet es.","Am Abend wird es ruhig.","Am Morgen bin ich m√ºde.","Der Himmel wird grau.",
      "Eine Wolke sieht komisch aus.","Der Regen platscht laut.","Die Strasse gl√§nzt nass.","Wir rennen √ºber die Br√ºcke.","Das Fenster klappert im Wind.","Die T√ºre f√§llt zu.","Ich lese heimlich weiter.","Wir schreiben viel zu langsam.","Die Rechnung stimmt nicht.","Die Kinder lachen laut.",
      "Alle rennen durcheinander.","Ich stolpere fast.","Die Katze verschwindet schnell.","Der Hund wartet draussen.","Das Pferd stampft nerv√∂s.","Mein Freund ruft mich.","Die Freundin winkt kurz.","Die Familie sitzt zusammen.","Im Garten ist es still.","Eine Blume ist kaputt.",
      "Der Baum knackt laut.","Die Wiese ist nass.","Ein Vogel flattert weg.","Die Katze beobachtet alles.","Der Hund zieht an der Leine.","Das Pferd schnaubt laut.","Ich h√∂re Schritte.","Wir verstecken uns schnell.","Alle schauen gespannt.","Dann wird es still."
    ];
    const SENT_LVL3 = [
      "Greg schloss die T√ºr, weil es draussen laut war.","Wir standen still, als jemand rief.","Ich drehte mich um, obwohl ich Angst hatte.","Der Ball rollte weiter, bis er im Geb√ºsch lag.","Sie fl√ºsterten leise, damit niemand sie h√∂rte.","Tom grinste, w√§hrend er den Plan erkl√§rte.","Wir warteten kurz, bevor wir losrannten.","Das Fahrrad kippte um, als der Weg rutschig wurde.","Ich blieb stehen, weil etwas raschelte.","Sie lachten laut, obwohl es unpassend war.",
      "Der Hund bellte, als die T√ºr aufging.","Wir duckten uns, sobald Schritte kamen.","Der Rucksack riss, weil er zu schwer war.","Ich sah nach oben, w√§hrend der Ball flog.","Sie fluchten leise, nachdem alles schiefging.","Wir rannten los, als das Signal kam.","Der Regen h√∂rte auf, bevor wir ankamen.","Ich tat so, als w√§re nichts passiert.","Sie tuschelten, obwohl alle zuh√∂rten.","Der Plan klang gut, bis jemand widersprach.",
      "Wir gingen weiter, obwohl der Weg dunkel war.","Er stolperte, weil er nicht aufpasste.","Ich hielt den Atem an, als es krachte.","Sie schauten sich an, w√§hrend niemand sprach.","Der Hund sprang vor, sobald die T√ºr offen war.","Wir versteckten uns, als das Licht anging.","Ich drehte mich um, weil jemand lachte.","Sie blieben stehen, obwohl sie rennen wollten.","Der Ball verschwand, nachdem er √ºberrollte.","Wir h√∂rten Stimmen, w√§hrend wir warteten.",
      "Ich schloss die Augen, als es laut knallte.","Sie grinste, obwohl sie nichts sagte.","Wir duckten uns, bevor jemand kam.","Der Wind pfiff, w√§hrend wir weitergingen.","Ich rannte los, als alle starrten.","Sie blieben ruhig, obwohl Chaos herrschte.","Der Hund folgte uns, bis wir verschwanden.","Wir h√∂rten auf, als es still wurde.","Ich schaute zur√ºck, w√§hrend sie winkten.","Sie lachten wieder, nachdem alles vorbei war.",
      "Der Plan √§nderte sich, weil etwas fehlte.","Wir warteten draussen, bis es dunkel wurde.","Ich fl√ºsterte, damit niemand uns h√∂rte.","Sie rannten weiter, obwohl sie m√ºde waren.","Der Ball tauchte wieder auf, als niemand rechnete.","Wir gingen langsam, weil der Boden nass war.","Ich nickte, obwohl ich zweifelte.","Sie schauten weg, als es peinlich wurde.","Wir blieben stehen, bis alles ruhig war.","Dann gingen wir weiter, als w√§re nichts gewesen."
    ];

    // ===== DOM =====
    const $ = (id)=>document.getElementById(id);

    const screenStart = $("screenStart");
    const screenQuiz = $("screenQuiz");
    const screenResult = $("screenResult");

    const btnModeWords = $("btnModeWords");
    const btnModeSent = $("btnModeSent");
    const btnLvlEasy = $("btnLvlEasy");
    const btnLvlMed = $("btnLvlMed");
    const btnLvlHard = $("btnLvlHard");
    const btnStart = $("btnStart");

    const progressText = $("progressText");
    const targetLine = $("targetLine");
    const spokenLine = $("spokenLine");
    const btnMic = $("btnMic");

    const feedback = $("feedback");
    const rightCount = $("rightCount");
    const wrongCount = $("wrongCount");

    const fallbackWrap = $("fallbackWrap");
    const fallbackInput = $("fallbackInput");
    const btnFallbackOk = $("btnFallbackOk");

    const resRight = $("resRight");
    const resWrong = $("resWrong");
    const btnDone = $("btnDone");
    const btnPractice = $("btnPractice");

    const srBadge = $("srBadge");
    const srAvail = $("srAvail");

    const overlay = $("overlay");
    const btnInfo = $("btnInfo");
    const btnCloseInfo = $("btnCloseInfo");
    const orderSel = $("orderSel");
    const removeFillers = $("removeFillers");
    const showExpectedOnFail = $("showExpectedOnFail");

    // ===== Student menu state =====
    let uiMode = "words";
    let uiLevel = "easy";
    function setMode(m){
      uiMode = m;
      btnModeWords.classList.toggle("selected", m==="words");
      btnModeSent.classList.toggle("selected", m==="sentences");
    }
    function setLevel(l){
      uiLevel = l;
      btnLvlEasy.classList.toggle("selected", l==="easy");
      btnLvlMed.classList.toggle("selected", l==="med");
      btnLvlHard.classList.toggle("selected", l==="hard");
    }
    setMode("words");
    setLevel("easy");
    btnModeWords.onclick = ()=>setMode("words");
    btnModeSent.onclick = ()=>setMode("sentences");
    btnLvlEasy.onclick = ()=>setLevel("easy");
    btnLvlMed.onclick  = ()=>setLevel("med");
    btnLvlHard.onclick = ()=>setLevel("hard");

    // ===== Teacher overlay =====
    function openInfo(){ overlay.classList.add("open"); }
    function closeInfo(){ overlay.classList.remove("open"); }
    btnInfo.onclick = openInfo;
    btnCloseInfo.onclick = closeInfo;
    overlay.addEventListener("click",(e)=>{ if(e.target===overlay) closeInfo(); });
    window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeInfo(); });

    // ===== Audio (init only after interaction) =====
    let audioOk=null, audioBad=null, audioWon=null;
    function ensureAudio(){
      if(audioOk && audioBad && audioWon) return;
      audioOk = new Audio(AUDIO_OK_URL);
      audioBad = new Audio(AUDIO_BAD_URL);
      audioWon = new Audio(AUDIO_WON_URL);
    }
    function play(a){
      if(!a) return;
      try{ a.currentTime=0; a.play(); }catch(_){}
    }
    const playOk = ()=>{ ensureAudio(); play(audioOk); };
    const playBad= ()=>{ ensureAudio(); play(audioBad); };
    const playWon= ()=>{ ensureAudio(); play(audioWon); };

    // ===== Helpers =====
    function setFeedback(msg, kind){
      feedback.textContent = msg;
      feedback.classList.remove("ok","bad");
      if(kind==="ok") feedback.classList.add("ok");
      if(kind==="bad") feedback.classList.add("bad");
    }

    function shuffleInPlace(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    // Fit target to one line by shrinking font-size until it fits
    function fitOneLine(el, maxPx=56, minPx=18){
      el.style.fontSize = maxPx+"px";
      let size = maxPx;
      let guard = 0;
      while(guard<80 && el.scrollWidth>el.clientWidth && size>minPx){
        size -= 2;
        el.style.fontSize = size+"px";
        guard++;
      }
      return size;
    }
    function setTargetDisplay(text){
      targetLine.textContent = text;
      const size = fitOneLine(targetLine, 56, 18);
      spokenLine.style.fontSize = size+"px"; // keep spoken same size
    }
    window.addEventListener("resize", ()=>{
      if(run && run.lastTarget) setTargetDisplay(run.lastTarget);
    });

    // ===== Normalization & deterministic matching =====
    function normalizeText(s, opts){
      const remove = !!(opts && opts.removeFillers);
      let t = (s||"").toLowerCase();

      try{ t = t.replace(/[^\p{L}\p{N}\s]/gu, " "); }
      catch(_){ t = t.replace(/[^a-z0-9√§√∂√º√ü\s]/gi, " "); }

      t = t.replace(/\s+/g," ").trim();
      t = t.replace(/√ü/g,"ss");

      if(remove){
        const parts = t.split(" ").filter(Boolean).filter(w => !FILLERS.has(w));
        t = parts.join(" ");
      }
      return t;
    }
    function tokenize(norm){ return norm ? norm.split(" ").filter(Boolean) : []; }
    function escapeRegex(s){ return (s||"").replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }
    function containsWholeWord(spokenNorm, targetNorm){
      const w = targetNorm.trim();
      if(!w) return false;
      const re = new RegExp("(^|\\s)"+escapeRegex(w)+"($|\\s)");
      return re.test(spokenNorm);
    }
    function subseqMatch(targetTokens, spokenTokens, threshold){
      if(!targetTokens.length) return false;
      let i=0;
      for(let j=0;j<spokenTokens.length && i<targetTokens.length;j++){
        if(spokenTokens[j]===targetTokens[i]) i++;
      }
      return (i/targetTokens.length) >= threshold;
    }
    function compareDeterministic(targetText, spokenRaw, mode){
      const tNorm = normalizeText(targetText, {removeFillers: removeFillers.checked});
      const sNorm = normalizeText(spokenRaw, {removeFillers: removeFillers.checked});
      if(!tNorm || !sNorm) return {ok:false, spokenNorm:sNorm, targetNorm:tNorm};

      if(mode==="words"){
        const tTokens = tokenize(tNorm);
        if(tTokens.length===1){
          return {ok: containsWholeWord(sNorm, tNorm), spokenNorm:sNorm, targetNorm:tNorm};
        }
        return {ok: subseqMatch(tTokens, tokenize(sNorm), 1.0), spokenNorm:sNorm, targetNorm:tNorm};
      }

      // sentences
      const longerIsSpoken = sNorm.length >= tNorm.length;
      if(longerIsSpoken && sNorm.includes(tNorm)) return {ok:true, spokenNorm:sNorm, targetNorm:tNorm};
      if(!longerIsSpoken && tNorm.includes(sNorm)) return {ok:true, spokenNorm:sNorm, targetNorm:tNorm};

      return {ok: subseqMatch(tokenize(tNorm), tokenize(sNorm), 0.90), spokenNorm:sNorm, targetNorm:tNorm};
    }

    // ===== Run state =====
    let run = null;

    function buildPool(){
      if(uiMode==="words"){
        if(uiLevel==="easy") return WORDS_LVL1.slice();
        if(uiLevel==="med") return WORDS_LVL2.slice();
        return WORDS_LVL3.slice();
      }else{
        if(uiLevel==="easy") return SENT_LVL1.slice();
        if(uiLevel==="med") return SENT_LVL2.slice();
        return SENT_LVL3.slice();
      }
    }
    function updateCounts(){
      rightCount.textContent = String(run ? run.right : 0);
      wrongCount.textContent = String(run ? run.wrong : 0);
    }
    function goStart(){
      screenStart.classList.remove("hidden");
      screenQuiz.classList.add("hidden");
      screenResult.classList.add("hidden");
      stopListening(false);
    }
    function goQuiz(){
      screenStart.classList.add("hidden");
      screenQuiz.classList.remove("hidden");
      screenResult.classList.add("hidden");
    }
    function goResult(){
      screenStart.classList.add("hidden");
      screenQuiz.classList.add("hidden");
      screenResult.classList.remove("hidden");
      stopListening(false);
      resRight.textContent = String(run ? run.right : 0);
      resWrong.textContent = String(run ? run.wrong : 0);
      if(run && run.right===TASKS_TOTAL && run.wrong===0) playWon();
    }

    function loadTask(){
      if(!run) return;
      if(run.index >= TASKS_TOTAL){ goResult(); return; }

      run.lastTarget = run.items[run.index];
      progressText.textContent = `Aufgabe ${run.index+1} von ${TASKS_TOTAL}`;

      setTargetDisplay(run.lastTarget);

      spokenLine.textContent = "";
      spokenLine.classList.add("hidden");

      setFeedback("Bereit.", "");
      updateCounts();

      if(!hasSR){
        fallbackWrap.classList.remove("hidden");
        fallbackInput.value = "";
      }else{
        fallbackWrap.classList.add("hidden");
      }
    }

    function startRun(){
      const items = buildPool();
      if(orderSel.value==="random") shuffleInPlace(items);
      run = { mode: uiMode, items, index:0, right:0, wrong:0, lastTarget:"" };
      goQuiz();
      loadTask();
      updateMicUI();
    }
    btnStart.onclick = startRun;

    // ===== SpeechRecognition (robust, button starts recording) =====
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const hasSR = !!SR;
    srBadge.textContent = hasSR ? "üéôÔ∏è bereit" : "üéôÔ∏è nicht verf√ºgbar";
    srAvail.textContent = hasSR ? "verf√ºgbar" : "nicht verf√ºgbar";

    let recognition = null;
    let isListening = false;

    let speechBuffer = "";
    let hadFinalChunk = false;
    let lastFinal = "";
    let silenceTimer = null;
    let pendingAutoFinalize = false;

    function clearSilence(){
      if(silenceTimer){ clearTimeout(silenceTimer); silenceTimer=null; }
    }
    function bumpSilenceTimer(){
      clearSilence();
      silenceTimer = setTimeout(()=>{
        if(isListening && hadFinalChunk){
          pendingAutoFinalize = true;
          stopListening(false);
        }
      }, SILENCE_MS);
    }

    function ensureRecognition(){
      if(!hasSR || recognition) return;

      recognition = new SR();
      recognition.lang = SR_LANG;
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.maxAlternatives = 8;

      recognition.onresult = (event)=>{
        // IMPORTANT: bump timer on any result (including interim),
        // but append only final chunks.
        bumpSilenceTimer();

        for(let i=event.resultIndex;i<event.results.length;i++){
          const res = event.results[i];
          const alt0 = res && res[0] ? res[0].transcript : "";
          const txt = (alt0 || "").trim();
          if(!txt) continue;

          if(res.isFinal){
            // dedup repeated finals
            if(txt !== lastFinal){
              lastFinal = txt;
              speechBuffer = (speechBuffer ? speechBuffer + " " : "") + txt;
              hadFinalChunk = true;
            }
          }
        }
      };

      recognition.onerror = (e)=>{
        // On many systems you only get results after permission; show helpful msg.
        setFeedback("Mikrofon/Spracherkennung-Fehler. Bitte Mikrofon erlauben und nochmals dr√ºcken.", "bad");
        pendingAutoFinalize = false;
        stopListening(true);
      };

      recognition.onend = ()=>{
        // Browser stops listening (also after stop())
        isListening = false;
        updateMicUI();
        clearSilence();

        if(pendingAutoFinalize){
          pendingAutoFinalize = false;
          finalizeAttempt();
        }
      };
    }

    function updateMicUI(){
      btnMic.textContent = isListening ? "‚èπÔ∏è Stop" : "üé§ Sprechen";
      btnMic.classList.toggle("bad", isListening);
      btnMic.classList.toggle("ok", !isListening);
      srBadge.textContent = hasSR ? (isListening ? "üéôÔ∏è h√∂rt zu‚Ä¶" : "üéôÔ∏è bereit") : "üéôÔ∏è nicht verf√ºgbar";
    }

    function startListening(){
      if(!hasSR) return;
      ensureRecognition();

      // reset attempt buffers
      speechBuffer = "";
      hadFinalChunk = false;
      lastFinal = "";
      pendingAutoFinalize = false;

      // spoken appears only after finish
      spokenLine.textContent = "";
      spokenLine.classList.add("hidden");

      try{
        recognition.lang = SR_LANG;
        recognition.start(); // MUST be inside click handler (user gesture)
        isListening = true;
        updateMicUI();
        setFeedback("Sprich jetzt.", "");
        bumpSilenceTimer();
      }catch(_){
        setFeedback("Spracherkennung konnte nicht gestartet werden. Bitte nochmals dr√ºcken.", "bad");
        isListening = false;
        updateMicUI();
      }
    }

    function stopListening(fromError){
      if(!hasSR || !recognition) return;
      try{ recognition.stop(); }catch(_){}
      isListening = false;
      updateMicUI();
      clearSilence();
      if(fromError){
        pendingAutoFinalize = false;
      }
    }

    function finalizeAttempt(){
      if(!run) return;

      const spokenRaw = (speechBuffer || "").trim();

      if(!spokenRaw){
        setFeedback("Ich habe dich nicht verstanden. Bitte nochmals sprechen.", "bad");
        ensureAudio(); playBad();
        spokenLine.textContent = "";
        spokenLine.classList.add("hidden");
        return;
      }

      const cmp = compareDeterministic(run.lastTarget, spokenRaw, run.mode);

      // show ONLY normalized spoken text (blue), after finished
      spokenLine.textContent = cmp.spokenNorm || "";
      spokenLine.classList.remove("hidden");

      if(cmp.ok){
        run.right++;
        setFeedback("Richtig ‚úÖ", "ok");
        ensureAudio(); playOk();
        updateCounts();

        setTimeout(()=>{
          run.index++;
          loadTask();
        }, 450);
      }else{
        run.wrong++;
        const extra = showExpectedOnFail.checked ? `  Richtig w√§re: ${run.lastTarget}` : "";
        setFeedback("Falsch ‚ùå" + extra, "bad");
        ensureAudio(); playBad();
        updateCounts();
        // repeat allowed: user presses "Sprechen" again
      }
    }

    // Mic button: START recording only when clicked
    btnMic.onclick = ()=>{
      ensureAudio(); // user interaction unlocks audio

      if(!hasSR){
        fallbackWrap.classList.remove("hidden");
        setFeedback("Spracherkennung ist nicht verf√ºgbar. Nutze das Eingabefeld.", "bad");
        return;
      }

      if(isListening){
        // manual stop => finalize if any final text exists
        pendingAutoFinalize = false;
        stopListening(false);
        setTimeout(()=>{
          if(hadFinalChunk) finalizeAttempt();
          else{
            setFeedback("Ich habe dich nicht verstanden. Bitte nochmals sprechen.", "bad");
            playBad();
            spokenLine.textContent = "";
            spokenLine.classList.add("hidden");
          }
        }, 120);
      }else{
        startListening();
      }
    };

    // Fallback
    btnFallbackOk.onclick = ()=>{
      ensureAudio();
      if(!run) return;

      const spokenRaw = (fallbackInput.value || "").trim();
      const cmp = compareDeterministic(run.lastTarget, spokenRaw, run.mode);

      spokenLine.textContent = cmp.spokenNorm || "";
      spokenLine.classList.remove("hidden");

      if(cmp.ok){
        run.right++;
        setFeedback("Richtig ‚úÖ", "ok");
        playOk();
        updateCounts();
        setTimeout(()=>{ run.index++; loadTask(); }, 450);
      }else{
        run.wrong++;
        const extra = showExpectedOnFail.checked ? `  Richtig w√§re: ${run.lastTarget}` : "";
        setFeedback("Falsch ‚ùå" + extra, "bad");
        playBad();
        updateCounts();
      }
    };

    // Results buttons
    btnDone.onclick = ()=>{ try{ window.parent.postMessage("AppSolved","*"); }catch(_){} };
    btnPractice.onclick = ()=>{ run=null; goStart(); };

    // Init
    if(!hasSR) fallbackWrap.classList.remove("hidden");
    else ensureRecognition();
    goStart();
    updateMicUI();
  })();
  </script>
</body>
</html>
